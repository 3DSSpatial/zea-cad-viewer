!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@zeainc/zea-engine")):"function"==typeof define&&define.amd?define(["exports","@zeainc/zea-engine"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).zeaUx={},e.zeaEngine)}(this,(function(e,t){"use strict";class a extends t.TreeItem{constructor(e){super(e),this.captured=!1,this.colorParam=this.addParameter(new t.ColorParameter("Color",new t.Color)),this.highlightColorParam=this.addParameter(new t.ColorParameter("HighlightColor",new t.Color(1,1,1)))}highlight(){this.emit("highlight")}unhighlight(){this.emit("unhighlight")}getManipulationPlane(){const e=this.getParameter("GlobalXfo").getValue();return new t.Ray(e.tr,e.ori.getZaxis())}onPointerEnter(e){this.highlight()}onPointerLeave(e){this.unhighlight()}onPointerDown(e){e.setCapture(this),e.stopPropagation(),this.captured=!0,e.changedTouches&&this.highlight(),e.viewport?this.handlePointerDown(e):e.vrviewport&&this.onVRControllerButtonDown(e)}onPointerMove(e){this.captured&&(e.stopPropagation(),e.viewport?this.handlePointerMove(e):e.vrviewport&&this.onVRPoseChanged(e)),e.preventDefault()}onPointerUp(e){this.captured&&(e.releaseCapture(),e.stopPropagation(),this.captured=!1,e.changedTouches&&this.unhighlight(),e.viewport?this.handlePointerUp(e):e.vrviewport&&this.onVRControllerButtonUp(e))}onWheel(e){}handlePointerDown(e){this.gizmoRay=this.getManipulationPlane();const t=e.pointerRay,a=t.intersectRayPlane(this.gizmoRay);return e.grabPos=t.pointAtDist(a),this.onDragStart(e),!0}handlePointerMove(e){const t=e.pointerRay,a=t.intersectRayPlane(this.gizmoRay);return e.holdPos=t.pointAtDist(a),this.onDrag(e),!0}handlePointerUp(e){const t=e.pointerRay;if(t){const a=t.intersectRayPlane(this.gizmoRay);e.releasePos=t.pointAtDist(a)}return this.onDragEnd(e),!0}onVRControllerButtonDown(e){this.activeController=e.controller;const t=this.activeController.getTipXfo().clone(),a=this.getManipulationPlane(),s=t.tr.subtract(a.start),i=t.tr.subtract(a.dir.scale(s.dot(a.dir)));return e.grabPos=i,this.onDragStart(e),!0}onVRPoseChanged(e){if(this.activeController){const t=this.activeController.getTipXfo(),a=this.getManipulationPlane(),s=t.tr.subtract(a.start),i=t.tr.subtract(a.dir.scale(s.dot(a.dir)));return e.holdPos=i,this.onDrag(e),!0}}onVRControllerButtonUp(e){if(this.activeController==e.controller){const t=this.activeController.getTipXfo();return this.onDragEnd(e,t.tr),this.activeController=void 0,!0}}onDragStart(e){console.warn("@Handle#onDragStart - Implement me!",e)}onDrag(e){console.warn("@Handle#onDrag - Implement me!",e)}onDragEnd(e){console.warn("@Handle#onDragEnd - Implement me!",e)}}class s extends a{constructor(e){super(e)}handlePointerDown(e){this.gizmoRay=this.getManipulationPlane();const t=e.pointerRay;this.grabDist=t.intersectRayVector(this.gizmoRay)[1];const a=this.gizmoRay.pointAtDist(this.grabDist);return e.grabDist=this.grabDist,e.grabPos=a,this.onDragStart(e),!0}handlePointerMove(e){const t=e.pointerRay.intersectRayVector(this.gizmoRay)[1],a=this.gizmoRay.pointAtDist(t);e.holdDist=t,e.holdPos=a,e.value=t,e.delta=t-this.grabDist,this.onDrag(e)}handlePointerUp(e){const t=e.pointerRay;if(t){const a=t.intersectRayVector(this.gizmoRay)[1],s=this.gizmoRay.pointAtDist(a);e.releasePos=s}return this.onDragEnd(e),!0}onVRControllerButtonDown(e){this.gizmoRay=this.getManipulationPlane(),this.activeController=e.controller;const t=this.activeController.getTipXfo();this.grabDist=t.tr.subtract(this.gizmoRay.start).dot(this.gizmoRay.dir);const a=this.gizmoRay.start.add(this.gizmoRay.dir.scale(this.grabDist));return e.grabPos=a,this.onDragStart(e),!0}onVRPoseChanged(e){const t=this.activeController.getTipXfo().tr.subtract(this.gizmoRay.start).dot(this.gizmoRay.dir),a=this.gizmoRay.start.add(this.gizmoRay.dir.scale(t));return e.value=t,e.holdPos=a,e.delta=t-this.grabDist,this.onDrag(e),!0}onVRControllerButtonUp(e){if(this.activeController==e.controller)return this.onDragEnd(),this.activeController=void 0,!0}}class i extends t.EventEmitter{constructor(){super(),this.__undoStack=[],this.__redoStack=[],this.__currChange=null,this.__currChangeUpdated=this.__currChangeUpdated.bind(this)}flush(){for(const e of this.__undoStack)e.destroy();this.__undoStack=[];for(const e of this.__redoStack)e.destroy();this.__redoStack=[],this.__currChange&&(this.__currChange.off("updated",this.__currChangeUpdated),this.__currChange=null)}addChange(e){this.__currChange&&this.__currChange.off&&this.__currChange.off("updated",this.__currChangeUpdated),this.__undoStack.push(e),this.__currChange=e,this.__currChange.on&&this.__currChange.on("updated",this.__currChangeUpdated);for(const e of this.__redoStack)e.destroy();this.__redoStack=[],this.emit("changeAdded",{change:e})}getCurrentChange(){return this.__currChange}__currChangeUpdated(e){this.emit("changeUpdated",e)}undo(e=!0){if(this.__undoStack.length>0){this.__currChange&&(this.__currChange.off("updated",this.__currChangeUpdated),this.__currChange=null);const t=this.__undoStack.pop();t.undo(),e&&(this.__redoStack.push(t),this.emit("changeUndone"))}}cancel(){if(this.__undoStack.length>0){this.__currChange&&(this.__currChange.off("updated",this.__currChangeUpdated),this.__currChange=null);this.__undoStack.pop().undo()}}redo(){if(this.__redoStack.length>0){const e=this.__redoStack.pop();e.redo(),this.__undoStack.push(e),this.emit("changeRedone")}}constructChange(e){return t.Registry.constructClass(e)}static isChangeClassRegistered(e){try{t.Registry.getBlueprintName(e);return!0}catch(e){return!1}}static getChangeClassName(e){return t.Registry.getBlueprintName(e)}static registerChange(e,a){t.Registry.register(e,a)}static getInstance(){return r||(r=new i),r}}let r;class n extends t.EventEmitter{constructor(e){super(),this.name=e||i.getChangeClassName(this)}undo(){throw new Error("Implement me")}redo(){throw new Error("Implement me")}update(e){throw new Error("Implement me")}toJSON(e){return{}}fromJSON(e,t){}updateFromJSON(e){this.update(e)}destroy(){}}class o extends n{constructor(e,t){e?(super(e?e.getName()+" Changed":"ParameterValueChange"),this.__prevValue=e.getValue(),this.__param=e,null!=t&&(this.__nextValue=t,this.__param.setValue(this.__nextValue))):super(),this.suppressPrimaryChange=!1,this.secondaryChanges=[]}undo(){this.__param&&(this.suppressPrimaryChange||this.__param.setValue(this.__prevValue),this.secondaryChanges.forEach((e=>e.undo())))}redo(){this.__param&&(this.suppressPrimaryChange||this.__param.setValue(this.__nextValue),this.secondaryChanges.forEach((e=>e.redo())))}update(e){this.__param&&(this.__nextValue=e.value,this.__param.setValue(this.__nextValue),this.emit("updated",e))}toJSON(e){const t={name:this.name,paramPath:this.__param.getPath()};return null!=this.__nextValue&&(this.__nextValue.toJSON?t.value=this.__nextValue.toJSON():t.value=this.__nextValue),t}fromJSON(e,a){const s=a.appData.scene.getRoot().resolvePath(e.paramPath,1);s&&s instanceof t.Parameter?(this.__param=s,this.__prevValue=this.__param.getValue(),this.__prevValue.clone?this.__nextValue=this.__prevValue.clone():this.__nextValue=this.__prevValue,this.name=e.name,null!=e.value&&this.updateFromJSON(e)):console.warn("resolvePath is unable to resolve",e.paramPath)}updateFromJSON(e){this.__param&&(this.__nextValue.fromJSON?this.__nextValue.fromJSON(e.value):this.__nextValue=e.value,this.__param.setValue(this.__nextValue))}}i.registerChange("ParameterValueChange",o);class h extends t.GLShader{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=t.shaderLibrary.parseShader("HandleShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;\n#ifdef ENABLE_TEXTURES\nattribute vec2 texCoords;\n#endif\n\n<%include file="GLSLUtils.glsl"/>\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n#ifdef ENABLE_MULTI_DRAW\n<%include file="materialparams.glsl"/>\n#else\nuniform int MaintainScreenSize;\nuniform float Overlay;\n#endif\n\n/* VS Outputs */\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\n\nvoid main(void) {\n  int drawItemId = getDrawItemId();\n  v_drawItemId = float(drawItemId);\n  v_geomItemData  = getInstanceData(drawItemId);\n  mat4 modelMatrix = getModelMatrix(drawItemId);\n  mat4 modelViewMatrix = viewMatrix * modelMatrix;\n\n  //////////////////////////////////////////////\n  // Material\n\n#ifdef ENABLE_MULTI_DRAW\n  vec2 materialCoords = v_geomItemData.zw;\n  vec4 materialValue1 = getMaterialValue(materialCoords, 1);\n  int maintainScreenSize = int(materialValue1.x + 0.5);\n  float overlay = materialValue1.y;\n#else\n  int maintainScreenSize = MaintainScreenSize;\n  float overlay = Overlay;\n#endif\n\n  //////////////////////////////////////////////\n  \n  if (maintainScreenSize != 0) {\n    float dist = modelViewMatrix[3][2];\n    float sc = abs(dist); // Note: items in front of the camera will have a negative value here.\n    mat4 scmat = mat4(\n      sc, 0.0, 0.0, 0.0,\n      0.0, sc, 0.0, 0.0,\n      0.0, 0.0, sc, 0.0,\n      0.0, 0.0, 0.0, 1.0\n    );\n    modelViewMatrix = modelViewMatrix * scmat;\n  }\n\n  vec4 viewPos = modelViewMatrix * vec4(positions, 1.0);\n  gl_Position = projectionMatrix * viewPos;\n\n  if(overlay > 0.0){\n    gl_Position.z = mix(gl_Position.z, -gl_Position.w, overlay);\n  }\n\n  v_viewPos = viewPos.xyz;\n  v_textureCoord = texCoords;\n  v_textureCoord.y = 1.0 - v_textureCoord.y;// Flip y\n}\n'),this.__shaderStages.FRAGMENT_SHADER=t.shaderLibrary.parseShader("HandleShader.fragmentShader",'\nprecision highp float;\n\n<%include file="GLSLUtils.glsl"/>\n<%include file="math/constants.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="stack-gl/gamma.glsl"/>\n<%include file="materialparams.glsl"/>\n\n\n#if defined(DRAW_COLOR)\n\nuniform color BaseColor;\n\n#ifdef ENABLE_TEXTURES\nuniform sampler2D BaseColorTex;\nuniform int BaseColorTexType;\n#endif\n\n#elif defined(DRAW_GEOMDATA)\n\nuniform int isOrthographic;\nimport \'surfaceGeomData.glsl\'\n\n#elif defined(DRAW_HIGHLIGHT)\n\n#ifdef ENABLE_FLOAT_TEXTURES\nvec4 getHighlightColor(int id) {\n  return fetchTexel(instancesTexture, instancesTextureSize, (id * pixelsPerItem) + 4);\n}\n#else // ENABLE_FLOAT_TEXTURES\n\nuniform vec4 highlightColor;\n\nvec4 getHighlightColor() {\n    return highlightColor;\n}\n\n#endif // ENABLE_FLOAT_TEXTURES\n\n#endif // DRAW_HIGHLIGHT\n\n/* VS Outputs */\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\n\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  int drawItemId = int(v_drawItemId + 0.5);\n\n  //////////////////////////////////////////////\n  // Color\n#if defined(DRAW_COLOR)\n\n\n#ifdef ENABLE_MULTI_DRAW\n\n  vec2 materialCoords = v_geomItemData.zw;\n  vec4 baseColor = toLinear(getMaterialValue(materialCoords, 0));\n\n#else // ENABLE_MULTI_DRAW\n\n#ifndef ENABLE_TEXTURES\n  vec4 baseColor = toLinear(BaseColor);\n#else\n  vec4 baseColor = getColorParamValue(BaseColor, BaseColorTex, BaseColorTexType, v_textureCoord);\n#endif // ENABLE_TEXTURES\n\n#endif // ENABLE_MULTI_DRAW\n\n  fragColor = baseColor;\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n  fragColor.rgb = toGamma(fragColor.rgb);\n#endif\n\n  //////////////////////////////////////////////\n  // GeomData\n#elif defined(DRAW_GEOMDATA)\n\n  fragColor = setFragColor_geomData(v_viewPos, floatGeomBuffer, passId, v_drawItemId, isOrthographic);\n\n  //////////////////////////////////////////////\n  // Highlight\n#elif defined(DRAW_HIGHLIGHT)\n  \n  fragColor = getHighlightColor(drawItemId);\n\n#endif // DRAW_HIGHLIGHT\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}static getParamDeclarations(){const e=super.getParamDeclarations();return e.push({name:"BaseColor",defaultValue:new t.Color(1,1,.5)}),e.push({name:"MaintainScreenSize",defaultValue:0}),e.push({name:"Overlay",defaultValue:0}),e}static getPackedMaterialData(e){const t=new Float32Array(8),a=e.getParameter("BaseColor").getValue();return t[0]=a.r,t[1]=a.g,t[2]=a.b,t[3]=a.a,t[4]=e.getParameter("MaintainScreenSize").getValue(),t[5]=e.getParameter("Overlay").getValue(),t}static isOverlay(){return!0}}t.Registry.register("HandleShader",h);const l=(e,t)=>{e.update();const a=e.getVertexAttribute("positions");for(let e=0;e<a.length;e++){const s=a.getValueRef(e),i=t.transformVec3(s);s.set(i.x,i.y,i.z)}};class c extends s{constructor(e,a=.1,s=.003,i=new t.Color){super(e),this.colorParam.setValue(i),this.handleMat=new t.Material("handle","HandleShader"),this.handleMat.getParameter("BaseColor").setValue(i),this.handleMat.getParameter("MaintainScreenSize").setValue(1),this.handleMat.getParameter("Overlay").setValue(.9);const r=new t.Cylinder(s,a,64);r.getParameter("BaseZAtZero").setValue(!0);const n=new t.Cone(4*s,10*s,64,!0),o=new t.GeomItem("handle",r,this.handleMat),h=new t.GeomItem("tip",n,this.handleMat),c=new t.Xfo;c.tr.set(0,0,a),l(n,c),this.colorParam.on("valueChanged",(()=>{this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())})),this.addChild(o),this.addChild(h)}highlight(){super.highlight(),this.handleMat.getParameter("BaseColor").setValue(this.highlightColorParam.getValue())}unhighlight(){super.unhighlight(),this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())}setTargetParam(e,t=!0){if(this.param=e,t){const t=()=>{this.getParameter("GlobalXfo").setValue(e.getValue())};t(),e.on("valueChanged",t)}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}onDragStart(e){this.grabPos=e.grabPos;const t=this.getTargetParam();this.baseXfo=t.getValue(),this.change=new o(t),i.getInstance().addChange(this.change)}onDrag(e){const t=e.holdPos.subtract(this.grabPos),a=this.baseXfo.clone();a.tr.addInPlace(t),this.change.update({value:a})}onDragEnd(e){this.change=null}}class g extends a{constructor(e){super(e)}setTargetParam(e,t=!0){if(this.param=e,t){const t=()=>{this.getParameter("GlobalXfo").setValue(e.getValue())};t(),e.on("valueChanged",t)}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}onDragStart(e){this.baseXfo=this.getParameter("GlobalXfo").getValue().clone(),this.baseXfo.sc.set(1,1,1),this.deltaXfo=new t.Xfo;const a=this.getTargetParam(),s=a.getValue();this.offsetXfo=this.baseXfo.inverse().multiply(s),this.vec0=e.grabPos.subtract(this.baseXfo.tr),this.grabCircleRadius=this.vec0.length(),this.vec0.normalizeInPlace(),this.change=new o(a),i.getInstance().addChange(this.change)}onDrag(e){const a=e.holdPos.subtract(this.baseXfo.tr);a.normalizeInPlace();let s=1*this.vec0.angleTo(a);if(this.vec0.cross(a).dot(this.baseXfo.ori.getZaxis())<0&&(s=-s),this.range&&(s=t.MathFunctions.clamp(s,this.range[0],this.range[1])),e.shiftKey){const e=Math.degToRad(22.5);s=Math.floor(s/e)*e}this.deltaXfo.ori.setFromAxisAndAngle(new t.Vec3(0,0,1),s);const i=this.baseXfo.multiply(this.deltaXfo).multiply(this.offsetXfo);this.change.update({value:i})}onDragEnd(e){this.change=null}}class d extends g{constructor(e,a,s,i=new t.Color(1,1,0)){super(e),this.radiusParam=this.addParameter(new t.NumberParameter("Radius",a)),this.colorParam.setValue(i),this.handleMat=new t.Material("handle","HandleShader"),this.handleMat.getParameter("BaseColor").setValue(i),this.handleMat.getParameter("MaintainScreenSize").setValue(1),this.handleMat.getParameter("Overlay").setValue(.9);const r=new t.Torus(s,a,64,.5*Math.PI);this.handle=new t.GeomItem("handle",r,this.handleMat),this.handleXfo=new t.Xfo,this.radiusParam.on("valueChanged",(()=>{a=this.radiusParam.getValue(),r.getParameter("OuterRadius").setValue(a),r.getParameter("InnerRadius").setValue(.02*a)})),this.colorParam.on("valueChanged",(()=>{this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())})),this.addChild(this.handle)}highlight(){super.highlight(),this.handleMat.getParameter("BaseColor").setValue(this.highlightColorParam.getValue())}unhighlight(){super.unhighlight(),this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())}getBaseXfo(){return this.getParameter("GlobalXfo").getValue()}onDragStart(e){super.onDragStart(e)}onDrag(e){super.onDrag(e)}onDragEnd(e){super.onDragEnd(e)}}class u extends a{constructor(e){super(e),this.fullXfoManipulationInVR=!0}setTargetParam(e,t=!0){if(this.param=e,t){const t=()=>{this.getParameter("GlobalXfo").setValue(e.getValue())};t(),e.on("valueChanged",t)}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}onDragStart(e){this.grabPos=e.grabPos;const t=this.getTargetParam();this.baseXfo=t.getValue(),this.change=new o(t),i.getInstance().addChange(this.change)}onDrag(e){const t=e.holdPos.subtract(this.grabPos),a=this.baseXfo.clone();a.tr.addInPlace(t),this.change.update({value:a})}onDragEnd(e){this.change=null}onVRControllerButtonDown(e){if(this.fullXfoManipulationInVR){this.activeController=e.controller;const t=this.activeController.getTipXfo(),a=this.getParameter("GlobalXfo").getValue();this.grabOffset=t.inverse().multiply(a)}else super.onVRControllerButtonDown(e);return!0}onVRPoseChanged(e){if(this.fullXfoManipulationInVR){const e=this.activeController.getTipXfo().multiply(this.grabOffset);if(this.change)this.change.update({value:e});else{this.getTargetParam().setValue(e)}}else super.onVRPoseChanged(e)}onVRControllerButtonUp(e){this.fullXfoManipulationInVR?this.change=null:super.onVRControllerButtonUp(e)}}class m extends u{constructor(e,a,s,i=new t.Color){super(e),this.sizeParam=this.addParameter(new t.NumberParameter("Size",a)),this.colorParam.setValue(i),this.handleMat=new t.Material("handle","HandleShader"),this.handleMat.getParameter("BaseColor").setValue(i),this.handleMat.getParameter("MaintainScreenSize").setValue(1),this.handleMat.getParameter("Overlay").setValue(.9);const r=new t.Cuboid(a,a,.02*a),n=new t.Xfo;n.tr=s,l(r,n),this.handle=new t.GeomItem("handle",r,this.handleMat),this.sizeParam.on("valueChanged",(()=>{a=this.sizeParam.getValue(),r.getParameter("X").setValue(a),r.getParameter("Y").setValue(a),r.getParameter("Z").setValue(.02*a)})),this.colorParam.on("valueChanged",(()=>{this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())})),this.addChild(this.handle)}highlight(){super.highlight(),this.handleMat.getParameter("BaseColor").setValue(this.highlightColorParam.getValue())}unhighlight(){super.unhighlight(),this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())}}class p extends t.TreeItem{constructor(e=.1,s=.003){super("XfoHandle"),this.highlightColorParam=this.addParameter(new t.ColorParameter("HighlightColor",new t.Color(1,1,1))),this.highlightColorParam.on("valueChanged",(()=>{const e=this.highlightColorParam.getValue();this.traverse((t=>{t instanceof a&&t.getParameter("HighlightColor").setValue(e)}))}));const i=new t.TreeItem("Translate");this.addChild(i);const r=new t.Color(1,.1,.1),n=new t.Color("#32CD32"),o=new t.Color("#1E90FF");r.a=1,n.a=1,o.a=1;{const a=new c("linearX",e,s,r),n=new t.Xfo;n.ori.setFromAxisAndAngle(new t.Vec3(0,1,0),.5*Math.PI),a.getParameter("LocalXfo").setValue(n),i.addChild(a)}{const a=new c("linearY",e,s,n),r=new t.Xfo;r.ori.setFromAxisAndAngle(new t.Vec3(1,0,0),-.5*Math.PI),a.getParameter("LocalXfo").setValue(r),i.addChild(a)}{const t=new c("linearZ",e,s,o);i.addChild(t)}const h=.35*e;{const e=new m("planarXY",h,new t.Vec3(.5*h,.5*h,0),o),a=new t.Xfo;e.getParameter("LocalXfo").setValue(a),i.addChild(e)}{const e=new m("planarYZ",h,new t.Vec3(-.5*h,.5*h,0),r),a=new t.Xfo;a.ori.setFromAxisAndAngle(new t.Vec3(0,1,0),.5*Math.PI),e.getParameter("LocalXfo").setValue(a),i.addChild(e)}{const e=new m("planarXZ",h,new t.Vec3(.5*h,.5*h,0),n),a=new t.Xfo;a.ori.setFromAxisAndAngle(new t.Vec3(1,0,0),.5*Math.PI),e.getParameter("LocalXfo").setValue(a),i.addChild(e)}const l=new t.TreeItem("Rotate");this.addChild(l);{const a=new d("rotationX",.75*e,s,r),i=new t.Xfo;i.ori.setFromEulerAngles(new t.EulerAngles(-.5*Math.PI,-.5*Math.PI,0)),a.getParameter("LocalXfo").setValue(i),l.addChild(a)}{const a=new d("rotationY",.75*e,s,n),i=new t.Xfo;i.ori.setFromAxisAndAngle(new t.Vec3(1,0,0),-.5*Math.PI),a.getParameter("LocalXfo").setValue(i),l.addChild(a)}{const a=new d("rotationZ",.75*e,s,o),i=new t.Xfo;i.ori.setFromAxisAndAngle(new t.Vec3(0,0,1),.5*Math.PI),a.getParameter("LocalXfo").setValue(i),l.addChild(a)}}_cleanGlobalXfo(){const e=this.getParentItem();if(void 0!==e){const t=e.getParameter("GlobalXfo").getValue().clone();return t.sc.set(1,1,1),t.multiply(this.__localXfoParam.getValue())}return this.__localXfoParam.getValue()}showHandles(e){this.setVisible(!0)}setTargetParam(e){this.param=e,this.traverse((t=>{t instanceof a&&t.setTargetParam(e,!1)}))}}class f extends t.Operator{constructor(e,a){super(),this.addInput(new t.OperatorInput("InitialXfoMode")).setParam(e),this.addOutput(new t.OperatorOutput("GroupGlobalXfo")).setParam(a),this.currGroupXfo=new t.Xfo}addItem(e){this.addInput(new t.OperatorInput("MemberGlobalXfo"+this.getNumInputs())).setParam(e.getParameter("GlobalXfo")),this.setDirty()}removeItem(e){const t=e.getParameter("GlobalXfo");for(let e=1;e<this.getNumInputs();e++){const a=this.getInputByIndex(e);if(a.getParam()==t)return this.removeInput(a),void this.setDirty()}throw new Error("Item not found in SelectionGroupXfoOperator")}backPropagateValue(e){const t=this.currGroupXfo.inverse(),a=e.multiply(t);a.ori.normalizeInPlace(),this.currGroupXfo=a.multiply(this.currGroupXfo);for(let e=1;e<this.getNumInputs();e++){const t=this.getInputByIndex(e),s=t.getValue(),i=a.multiply(s);t.setValue(i)}}evaluate(){const e=this.getOutput("GroupGlobalXfo");if(this.currGroupXfo=new t.Xfo,1==this.getNumInputs())return void e.setClean(this.currGroupXfo);const a=this.getInput("InitialXfoMode").getValue();if(a!=t.Group.INITIAL_XFO_MODES.manual){if(a==t.Group.INITIAL_XFO_MODES.first){const e=this.getInputByIndex(1).getValue();this.currGroupXfo.tr=e.tr.clone(),this.currGroupXfo.ori=e.ori.clone()}else if(a==t.Group.INITIAL_XFO_MODES.average){this.currGroupXfo.ori.set(0,0,0,0);let e=0;for(let t=1;t<this.getNumInputs();t++){const a=this.getInputByIndex(t).getValue();this.currGroupXfo.tr.addInPlace(a.tr),0==e&&this.currGroupXfo.ori.addInPlace(a.ori),e++}this.currGroupXfo.tr.scaleInPlace(1/e)}else{if(a!=t.Group.INITIAL_XFO_MODES.globalOri)throw new Error("Invalid Group.INITIAL_XFO_MODES.");{let e=0;for(let t=1;t<this.getNumInputs();t++){const a=this.getInputByIndex(t).getValue();this.currGroupXfo.tr.addInPlace(a.tr),e++}this.currGroupXfo.tr.scaleInPlace(1/e)}}this.currGroupXfo.ori.normalizeInPlace(),e.setClean(this.currGroupXfo)}else this.currGroupXfo=e.getValue().clone()}}const P={disabled:0,manual:1,first:2,average:3,globalOri:4};class I extends t.SelectionSet{constructor(e){let a,s;super(),a=e.selectionOutlineColor?e.selectionOutlineColor:new t.Color(3/255,227/255,172/255,.1),e.branchSelectionOutlineColor?s=e.branchSelectionOutlineColor:(s=a.lerp(new t.Color("white"),.5),s.a=.1),this.getParameter("HighlightColor").setValue(a),this.addParameter(new t.ColorParameter("SubtreeHighlightColor",s)),this.__itemsParam.setFilterFn((e=>e instanceof t.BaseItem)),this.__initialXfoModeParam=this.addParameter(new t.MultiChoiceParameter("InitialXfoMode",P.average,["manual","first","average","global"])),this.selectionGroupXfoOp=new f(this.getParameter("InitialXfoMode"),this.getParameter("GlobalXfo"))}static get INITIAL_XFO_MODES(){return P}clone(){const e=new I;return e.copyFrom(this),e}__bindItem(e,a){if(e instanceof t.TreeItem){const s=this.getParameter("HighlightColor").getValue();s.a=this.getParameter("HighlightFill").getValue(),e.addHighlight("selected"+this.getId(),s,!1);const i=this.getParameter("SubtreeHighlightColor").getValue();e.getChildren().forEach((e=>{e instanceof t.TreeItem&&e.addHighlight("branchselected"+this.getId(),i,!0)})),this.selectionGroupXfoOp.addItem(e,a)}}__unbindItem(e,a){e instanceof t.TreeItem&&(e.removeHighlight("selected"+this.getId()),e.getChildren().forEach((e=>{e instanceof t.TreeItem&&e.removeHighlight("branchselected"+this.getId(),!0)})),this.selectionGroupXfoOp.removeItem(e,a))}}class C extends n{constructor(e,t,a){super("SelectionChange"),this.__selectionManager=e,this.__prevSelection=t,this.__newSelection=a}undo(){this.__selectionManager.setSelection(this.__prevSelection,!1)}redo(){this.__selectionManager.setSelection(this.__newSelection,!1)}toJSON(e){const t=super.toJSON(e),a=[];for(const e of this.__newSelection)a.push(e.getPath());return t.itemPaths=a,t}fromJSON(e,t){super.fromJSON(e,t),this.__selectionManager=t.appData.selectionManager,this.__prevSelection=new Set(this.__selectionManager.getSelection());const a=t.appData.scene.getRoot(),s=new Set;for(const t of e.itemPaths)s.add(a.resolvePath(t,1));this.__newSelection=s,this.__selectionManager.setSelection(this.__newSelection,!1)}}i.registerChange("SelectionChange",C);class _ extends n{constructor(e,t){super("Selection Visibility Change"),this.selection=e,this.state=t,this._changeItemsVisibility(this.state)}undo(){this._changeItemsVisibility(!this.state)}redo(){this._changeItemsVisibility(this.state)}_changeItemsVisibility(e){for(const t of this.selection)t.getParameter("Visible").setValue(e)}}i.registerChange("ToggleSelectionVisibility",_);class v extends t.EventEmitter{constructor(e,a={}){if(super(),this.appData=e,this.leadSelection=void 0,this.selectionGroup=new I(a),!0===a.enableXfoHandles){const e=.1,a=.02*e;this.xfoHandle=new p(e,a),this.xfoHandle.setTargetParam(this.selectionGroup.getParameter("GlobalXfo"),!1),this.xfoHandle.setVisible(!1),this.xfoHandle.getParameter("HighlightColor").setValue(new t.Color(1,1,0)),this.xfoHandleVisible=!0,this.selectionGroup.addChild(this.xfoHandle)}this.appData.renderer&&this.setRenderer(this.appData.renderer)}setRenderer(e){this.__renderer!=e?(this.__renderer=e,this.__renderer.addTreeItem(this.selectionGroup)):console.warn("Renderer already set on SelectionManager")}setXfoMode(e){this.xfoHandle&&this.selectionGroup.getParameter("InitialXfoMode").setValue(e)}showHandles(e){this.xfoHandleVisible=e}updateHandleVisibility(){if(!this.xfoHandle)return;const e=this.selectionGroup.getItems(),t=Array.from(e).length>0;this.xfoHandle.setVisible(t&&this.xfoHandleVisible),this.__renderer.requestRedraw()}getSelection(){return this.selectionGroup.getItems()}setSelection(e,t=!0){const a=new Set(this.selectionGroup.getItems()),s=new Set(a);for(const t of e)a.has(t)||(t.setSelected(!0),a.add(t));for(const t of a)e.has(t)||(t.setSelected(!1),a.delete(t));if(this.selectionGroup.setItems(a),a.size>0?this.__setLeadSelection(a.values().next().value):this.__setLeadSelection(),this.updateHandleVisibility(),t){const e=new C(this,s,a);i.getInstance().addChange(e)}this.emit("selectionChanged",{prevSelection:s,selection:a})}__setLeadSelection(e){this.leadSelection!=e&&(this.leadSelection=e,this.emit("leadSelectionChanged",{treeItem:e}))}toggleItemSelection(e,t=!0){const a=new Set(this.selectionGroup.getItems()),s=new Set(a);if(t&&(1!=a.size||!a.has(e))){let t=!0;if(a.has(e)){let s=1;e.traverse((e=>{a.has(e)&&s++})),t=s!=a.size}t&&(Array.from(a).forEach((e=>{e.setSelected(!1)})),a.clear())}let r;a.has(e)?(e.setSelected(!1),a.delete(e),r=!1):(e.setSelected(!0),a.add(e),r=!0),this.selectionGroup.setItems(a),r&&1===a.size?this.__setLeadSelection(e):r||(1===a.size?this.__setLeadSelection(a.values().next().value):0===a.size&&this.__setLeadSelection());const n=new C(this,s,a);i.getInstance().addChange(n),this.updateHandleVisibility(),this.emit("selectionChanged",{prevSelection:s,selection:a})}clearSelection(e=!0){const t=new Set(this.selectionGroup.getItems());if(0==t.size)return!1;let a;e&&(a=new Set(t));for(const e of t)e.setSelected(!1);if(t.clear(),this.selectionGroup.setItems(t),this.updateHandleVisibility(),e){const e=new C(this,a,t);i.getInstance().addChange(e),this.emit("selectionChanged",{selection:t,prevSelection:a})}return!0}selectItems(e,t=!0){const a=new Set(this.selectionGroup.getItems()),s=new Set(a);t&&a.clear();for(const t of e)a.has(t)||(t.setSelected(!0),a.add(t));const r=new C(this,s,a);i.getInstance().addChange(r),this.selectionGroup.setItems(a),1===a.size?this.__setLeadSelection(a.values().next().value):0===a.size&&this.__setLeadSelection(),this.updateHandleVisibility(),this.emit("selectionChanged",{prevSelection:s,selection:a})}deselectItems(e){const t=new Set(this.selectionGroup.getItems()),a=new Set(t);for(const a of e)t.has(a)&&(a.setSelected(!1),t.delete(a));this.selectionGroup.setItems(t);const s=new C(this,a,t);i.getInstance().addChange(s),1===t.size?this.__setLeadSelection(t.values().next().value):0===t.size&&this.__setLeadSelection(),this.updateHandleVisibility(),this.emit("selectionChanged",{prevSelection:a,selection:t})}toggleSelectionVisibility(){if(this.leadSelection){const e=this.selectionGroup.getItems(),t=!this.leadSelection.getVisible(),a=new _(e,t);i.getInstance().addChange(a)}}startPickingMode(e,t,a,s){console.log(e),this.__pickCB=t,this.__pickFilter=a,this.__pickCount=s,this.__picked=[]}pickingFilter(e){return this.__pickFilter(e)}pickingModeActive(){return null!=this.__pickCB}cancelPickingMode(){this.__pickCB=void 0}pick(e){if(this.__pickCB){if(Array.isArray(e))this.__pickFilter?this.__picked=this.__picked.concat(e.filter(this.__pickFilter)):this.__picked=this.__picked.concat(e);else{if(this.__pickFilter&&!this.__pickFilter(e))return;this.__picked.push(e)}this.__picked.length==this.__pickCount&&(this.__pickCB(this.__picked),this.__pickCB=void 0)}}}class w extends n{constructor(e,t,a){e?(super(e.getName()+" Added"),this.treeItem=e,this.owner=t,this.selectionManager=a,this.prevSelection=new Set(this.selectionManager.getSelection()),this.treeItemIndex=this.owner.addChild(this.treeItem),this.selectionManager.setSelection(new Set([this.treeItem]),!1),this.treeItem.addRef(this)):super()}undo(){if(this.treeItem instanceof t.Operator){this.treeItem.detach()}else this.treeItem instanceof t.TreeItem&&this.treeItem.traverse((e=>{if(e instanceof t.Operator){e.detach()}}),!1);this.owner.removeChild(this.treeItemIndex),this.selectionManager&&this.selectionManager.setSelection(this.prevSelection,!1)}redo(){if(this.treeItem instanceof t.Operator){this.treeItem.reattach()}else subTreeItem instanceof t.TreeItem&&this.treeItem.traverse((e=>{if(e instanceof t.Operator){e.reattach()}}),!1);this.owner.addChild(this.treeItem),this.selectionManager&&this.selectionManager.setSelection(new Set([this.treeItem]),!1)}toJSON(e){return{name:this.name,treeItem:this.treeItem.toJSON(e),treeItemPath:this.treeItem.getPath(),treeItemIndex:this.treeItemIndex}}fromJSON(e,a){const s=t.Registry.constructClass(e.treeItem.type);s?(this.name=e.name,this.treeItem=s,this.treeItem.addRef(this),this.treeItem.fromJSON(e.treeItem,a),this.treeItemIndex=this.owner.addChild(this.treeItem,!1,!1)):console.warn("resolvePath is unable to construct",e.treeItem)}destroy(){this.treeItem.removeRef(this)}}i.registerChange("TreeItemAddChange",w);class V extends n{constructor(e,t){e?(super(e.getName()+" Moved"),this.treeItem=e,this.oldOwner=this.treeItem.getOwner(),this.oldOwnerIndex=this.oldOwner.getChildIndex(this.treeItem),this.newOwner=t,this.newOwner.addChild(this.treeItem,!0)):super()}undo(){this.oldOwner.insertChild(this.treeItem,this.oldOwnerIndex,!0)}redo(){this.newOwner.addChild(this.treeItem,!0)}toJSON(e){return{name:this.name,treeItemPath:this.treeItem.getPath(),newOwnerPath:this.newOwner.getPath()}}fromJSON(e,t){const a=appData.scene.getRoot().resolvePath(e.treeItemPath,1);if(!a)return void console.warn("resolvePath is unable to resolve",e.treeItemPath);const s=appData.scene.getRoot().resolvePath(e.newOwnerPath,1);s?(this.name=e.name,this.treeItem=a,this.newOwner=s,this.oldOwner=this.treeItem.getOwner(),this.oldOwnerIndex=this.oldOwner.getChildIndex(this.treeItem),this.newOwner.addChild(this.treeItem,!0)):console.warn("resolvePath is unable to resolve",e.newOwnerPath)}}i.registerChange("TreeItemMoveChange",V);class S extends n{constructor(e,a){if(super(),this.items=[],this.itemOwners=[],this.itemPaths=[],this.itemIndices=[],e){this.selectionManager=a.selectionManager,this.prevSelection=new Set(this.selectionManager.getSelection()),this.items=e,this.newSelection=new Set(this.prevSelection);const s=[];this.items.forEach((e=>{const a=e.getOwner(),i=a.getChildIndex(e);if(s.push(e.getName()),e.addRef(this),this.itemOwners.push(a),this.itemPaths.push(e.getPath()),this.itemIndices.push(i),this.selectionManager&&this.newSelection.has(e)&&this.newSelection.delete(e),e instanceof t.Operator){e.detach()}else e instanceof t.TreeItem&&e.traverse((e=>{if(e instanceof t.Operator){e.detach()}this.selectionManager&&this.newSelection.has(e)&&this.newSelection.delete(e)}),!1);a.removeChild(i)})),this.selectionManager.setSelection(this.newSelection,!1),this.name=s+" Deleted"}}undo(){this.items.forEach(((e,a)=>{if(this.itemOwners[a].insertChild(e,this.itemIndices[a],!1,!1),e instanceof t.Operator){e.reattach()}else subTreeItem instanceof t.TreeItem&&e.traverse((e=>{if(e instanceof t.Operator){e.reattach()}}),!1)})),this.selectionManager&&this.selectionManager.setSelection(this.prevSelection,!1)}redo(){this.selectionManager&&this.selectionManager.setSelection(this.newSelection,!1),this.items.forEach(((e,a)=>{if(this.itemOwners[a].removeChild(this.itemIndices[a]),e instanceof t.Operator){e.detach()}else subTreeItem instanceof t.TreeItem&&e.traverse((e=>{if(e instanceof t.Operator){e.detach()}}),!1)}))}toJSON(e){const t={name:this.name,items:[],itemPaths:this.itemPaths,itemIndices:this.itemIndices};return this.items.forEach((e=>{t.items.push(e.toJSON())})),t}fromJSON(e,t){this.name=e.name,e.itemPaths.forEach((e=>{const a=t.scene.getRoot().resolvePath(e,1);if(!a)return void console.warn("resolvePath is unable to resolve",e);const s=a.getOwner();this.itemOwners.push(s),this.itemPaths.push(a.getPath()),this.itemIndices.push(s.getChildIndex(a))}))}destroy(){this.items.forEach((e=>e.removeRef(this)))}}i.registerChange("TreeItemsRemoveChange",S);class b extends t.BaseTool{constructor(e){super(),e||console.error("App data not provided to tool"),this.appData=e,this.dragging=!1,e.selectionManager||console.error("`SelectionTool` requires `SelectionManager` to be provided in the `appData` object"),this.selectionManager=e.selectionManager,this.selectionRect=new t.Rect(1,1),this.selectionRectMat=new t.Material("marker","ScreenSpaceShader"),this.selectionRectMat.getParameter("BaseColor").setValue(new t.Color("#03E3AC")),this.selectionRectXfo=new t.Xfo,this.selectionRectXfo.tr.set(.5,.5,0),this.selectionRectXfo.sc.set(0,0,0),this.rectItem=new t.GeomItem("selectionRect",this.selectionRect,this.selectionRectMat),this.rectItem.getParameter("Visible").setValue(!1),this.appData.renderer.addTreeItem(this.rectItem)}activateTool(){super.activateTool(),this.prevCursor=this.appData.renderer.getGLCanvas().style.cursor,this.appData.renderer.getGLCanvas().style.cursor="auto"}deactivateTool(){super.deactivateTool(),this.appData.renderer.getGLCanvas().style.cursor=this.prevCursor}setSelectionManager(e){this.selectionManager=e}setSelectionFilter(e){this.__selectionFilterFn=e}activateTool(){super.activateTool()}deactivateTool(){super.deactivateTool(),this.selectionRectXfo.sc.set(0,0,0),this.rectItem.getParameter("GlobalXfo").setValue(this.selectionRectXfo),this.rectItem.getParameter("Visible").setValue(!1)}__resizeRect(e,a){const s=new t.Vec2(1/e.getWidth()*2,1/e.getHeight()*2),i=a.multiply(s);this.selectionRectXfo.sc.set(Math.abs(i.x),Math.abs(i.y),1);const r=this.pointerDownPos.subtract(a.scale(.5)).multiply(s).subtract(new t.Vec2(1,1));this.selectionRectXfo.tr.x=r.x,this.selectionRectXfo.tr.y=-r.y,this.rectItem.getParameter("GlobalXfo").setValue(this.selectionRectXfo)}onPointerDoublePress(e){}onPointerDown(e){("touch"===e.pointerType||0==e.button&&!e.altKey)&&(this.pointerDownPos=e.pointerPos,this.dragging=!1,e.stopPropagation())}onPointerMove(e){if(this.pointerDownPos){const t=this.pointerDownPos.subtract(e.pointerPos);t.length()>4&&(this.dragging=!0,this.rectItem.getParameter("Visible").setValue(!0),this.__resizeRect(e.viewport,t)),e.stopPropagation()}}onPointerUp(e){if(this.pointerDownPos){if(this.dragging){this.rectItem.getParameter("Visible").setValue(!1);const s=e.pointerPos,i=new t.Vec2(Math.min(this.pointerDownPos.x,s.x),Math.min(this.pointerDownPos.y,s.y)),r=new t.Vec2(Math.max(this.pointerDownPos.x,s.x),Math.max(this.pointerDownPos.y,s.y));let n=e.viewport.getGeomItemsInRect(i,r);if(this.__selectionFilterFn){const e=[];for(let t=0;t<n.length;t++){const a=this.__selectionFilterFn(n[t]);e.includes(a)||e.push(a)}n=e}if(!this.selectionManager)throw"Please set the Selection Manager on the Selection Tool before using it.";if(this.selectionManager.pickingModeActive())this.selectionManager.pick(n);else{const t=new Set([...n].filter((e=>!(e.getOwner()instanceof a))));e.shiftKey?this.selectionManager.deselectItems(t):this.selectionManager.selectItems(t,!e.ctrlKey),this.selectionRectXfo.sc.set(0,0,0),this.rectItem.getParameter("GlobalXfo").setValue(this.selectionRectXfo)}}else{const t=e.viewport.getGeomDataAtPos(e.pointerPos);if(null==t||t.geomItem.getOwner()instanceof a)this.selectionManager.clearSelection();else{let a=t.geomItem;if(this.__selectionFilterFn&&(a=this.__selectionFilterFn(a)),this.selectionManager.pickingModeActive())this.selectionManager.pick(a);else if(e.shiftKey){const e=new Set;e.add(a),this.selectionManager.deselectItems(e)}else this.selectionManager.toggleItemSelection(a,!e.ctrlKey)}}this.pointerDownPos=void 0,e.stopPropagation()}}onVRControllerButtonDown(e){if(1==e.button){if(!this.selectionManager)throw"Please set the Selection Manager on the Selection Tool before using it.";const t=e.controller.getGeomItemAtTip();null==t||t.geomItem.getOwner()instanceof a||(this.selectionManager.toggleItemSelection(t.geomItem),e.stopPropagation())}}}const y=function(){return{escape:function(e){return e.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1")},parseExtension:e,mimeType:function(t){const a=e(t).toLowerCase();return function(){const e="application/font-woff",t="image/jpeg";return{woff:e,woff2:e,ttf:"application/font-truetype",eot:"application/vnd.ms-fontobject",png:"image/png",jpg:t,jpeg:t,gif:"image/gif",tiff:"image/tiff",svg:"image/svg+xml"}}()[a]||""},dataAsUrl:function(e,t){return"data:"+t+";base64,"+e},isDataUrl:function(e){return-1!==e.search(/^(data:)/)},canvasToBlob:function(e){return e.toBlob?new Promise((function(t){e.toBlob(t)})):function(e){return new Promise((function(t){const a=window.atob(e.toDataURL().split(",")[1]),s=a.length,i=new Uint8Array(s);for(let e=0;e<s;e++)i[e]=a.charCodeAt(e);t(new Blob([i],{type:"image/png"}))}))}(e)},resolveUrl:function(e,t){const a=document.implementation.createHTMLDocument(),s=a.createElement("base");a.head.appendChild(s);const i=a.createElement("a");return a.body.appendChild(i),s.href=t,i.href=e,i.href},getAndEncode:function(e){const t=3e4;A.impl.options.cacheBust&&(e+=(/\?/.test(e)?"&":"?")+(new Date).getTime());return new Promise((function(a){const s=new XMLHttpRequest;let i;if(s.onreadystatechange=r,s.ontimeout=n,s.responseType="blob",s.timeout=t,s.open("GET",e,!0),s.send(),A.impl.options.imagePlaceholder){const e=A.impl.options.imagePlaceholder.split(/,/);e&&e[1]&&(i=e[1])}function r(){if(4!==s.readyState)return;if(200!==s.status)return void(i?a(i):o("cannot fetch resource: "+e+", status: "+s.status));const t=new FileReader;t.onloadend=function(){const e=t.result.split(/,/)[1];a(e)},t.readAsDataURL(s.response)}function n(){i?a(i):o("timeout of "+t+"ms occured while fetching resource: "+e)}function o(e){console.error(e),a("")}}))},uid:function(){let e=0;return function(){return"u"+t()+e++;function t(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).slice(-4)}}}(),delay:function(e){return function(t){return new Promise((function(a){setTimeout((function(){a(t)}),e)}))}},asArray:function(e){const t=[],a=e.length;for(let s=0;s<a;s++)t.push(e[s]);return t},escapeXhtml:function(e){return e.replace(/#/g,"%23").replace(/\n/g,"%0A")},makeImage:function(e){return new Promise((function(t,a){const s=new Image;s.onload=function(){t(s)},s.onerror=a,s.src=e}))},width:function(e){const a=t(e,"border-left-width"),s=t(e,"border-right-width");return e.scrollWidth+a+s},height:function(e){const a=t(e,"border-top-width"),s=t(e,"border-bottom-width");return e.scrollHeight+a+s}};function e(e){const t=/\.([^\.\/]*?)$/g.exec(e);return t?t[1]:""}function t(e,t){const a=window.getComputedStyle(e).getPropertyValue(t);return parseFloat(a.replace("px",""))}}(),T=function(){const e=/url\(['"]?([^'"]+?)['"]?\)/g;return{inlineAll:function(e,i,r){return n()?Promise.resolve(e):Promise.resolve(e).then(a).then((function(t){let a=Promise.resolve(e);return t.forEach((function(e){a=a.then((function(t){return s(t,e,i,r)}))})),a}));function n(){return!t(e)}},shouldProcess:t,impl:{readUrls:a,inline:s}};function t(t){return-1!==t.search(e)}function a(t){const a=[];let s;for(;null!==(s=e.exec(t));)a.push(s[1]);return a.filter((function(e){return!y.isDataUrl(e)}))}function s(e,t,a,s){return Promise.resolve(t).then((function(e){return a?y.resolveUrl(e,a):e})).then(s||y.getAndEncode).then((function(e){return y.dataAsUrl(e,y.mimeType(t))})).then((function(a){return e.replace(function(e){return new RegExp("(url\\(['\"]?)("+y.escape(e)+")(['\"]?\\))","g")}(t),"$1"+a+"$3")}))}}(),M=function(){return{resolveAll:function(){return e().then((function(e){return Promise.all(e.map((function(e){return e.resolve()})))})).then((function(e){return e.join("\n")}))},impl:{readAll:e}};function e(){return Promise.resolve(y.asArray(document.styleSheets)).then((function(e){const t=[];return e.forEach((function(e){try{y.asArray(e.cssRules||[]).forEach(t.push.bind(t))}catch(t){console.log("Error while reading CSS rules from "+e.href,t.toString())}})),t})).then((function(e){return e.filter((function(e){return e.type===CSSRule.FONT_FACE_RULE})).filter((function(e){return T.shouldProcess(e.style.getPropertyValue("src"))}))})).then((function(t){return t.map(e)}));function e(e){return{resolve:function(){const t=(e.parentStyleSheet||{}).href;return T.inlineAll(e.cssText,t)},src:function(){return e.style.getPropertyValue("src")}}}}}(),X=function(){return{inlineAll:function t(a){return a instanceof Element?s(a).then((function(){return a instanceof HTMLImageElement?e(a).inline():Promise.all(y.asArray(a.childNodes).map((function(e){return t(e)})))})):Promise.resolve(a);function s(e){const t=e.style.getPropertyValue("background");return t?T.inlineAll(t).then((function(t){e.style.setProperty("background",t,e.style.getPropertyPriority("background"))})).then((function(){return e})):Promise.resolve(e)}},impl:{newImage:e}};function e(e){return{inline:function(t){return y.isDataUrl(e.src)?Promise.resolve():Promise.resolve(e.src).then(t||y.getAndEncode).then((function(t){return y.dataAsUrl(t,y.mimeType(e.src))})).then((function(t){return new Promise((function(a,s){e.onload=a,e.onerror=s,e.src=t}))}))}}}}(),D={imagePlaceholder:void 0,cacheBust:!1},A={toSvg:x,toPng:function(e,t){return R(e,t||{}).then((function(e){return e.toDataURL()}))},toJpeg:function(e,t){return R(e,t=t||{}).then((function(e){return e.toDataURL("image/jpeg",t.quality||1)}))},toBlob:function(e,t){return R(e,t||{}).then(y.canvasToBlob)},toPixelData:function(e,t){return R(e,t||{}).then((function(t){return t.getContext("2d").getImageData(0,0,y.width(e),y.height(e)).data}))},toCanvas:function(e,t){return R(e,t||{}).then((function(e){return e}))},impl:{fontFaces:M,images:X,util:y,inliner:T,options:{}}};function x(e,t){return function(e){void 0===e.imagePlaceholder?A.impl.options.imagePlaceholder=D.imagePlaceholder:A.impl.options.imagePlaceholder=e.imagePlaceholder;void 0===e.cacheBust?A.impl.options.cacheBust=D.cacheBust:A.impl.options.cacheBust=e.cacheBust}(t=t||{}),Promise.resolve(e).then((function(e){return G(e,t.filter,!0)})).then(O).then(B).then((function(e){t.bgcolor&&(e.style.backgroundColor=t.bgcolor);t.width&&(e.style.width=t.width+"px");t.height&&(e.style.height=t.height+"px");t.style&&Object.keys(t.style).forEach((function(a){e.style[a]=t.style[a]}));return e})).then((function(a){return function(e,t,a){return Promise.resolve(e).then((function(e){return e.setAttribute("xmlns","http://www.w3.org/1999/xhtml"),(new XMLSerializer).serializeToString(e)})).then(y.escapeXhtml).then((function(e){return'<foreignObject x="0" y="0" width="100%" height="100%">'+e+"</foreignObject>"})).then((function(e){return'<svg xmlns="http://www.w3.org/2000/svg" width="'+t+'" height="'+a+'">'+e+"</svg>"})).then((function(e){return"data:image/svg+xml;charset=utf-8,"+e}))}(a,t.width||y.width(e),t.height||y.height(e))}))}function R(e,t){return x(e,t).then(y.makeImage).then(y.delay(100)).then((function(a){const s=function(e){const a=document.createElement("canvas");if(a.width=t.width||y.width(e),a.height=t.height||y.height(e),t.bgcolor){const e=a.getContext("2d");e.fillStyle=t.bgcolor,e.fillRect(0,0,a.width,a.height)}return a}(e);return s.getContext("2d").drawImage(a,0,0),s}))}function G(e,t,a){return a||!t||t(e)?Promise.resolve(e).then((function(e){return e instanceof HTMLCanvasElement?y.makeImage(e.toDataURL()):e.cloneNode(!1)})).then((function(a){return function(e,t,a){const s=e.childNodes;return 0===s.length?Promise.resolve(t):i(t,y.asArray(s),a).then((function(){return t}));function i(e,t,a){let s=Promise.resolve();return t.forEach((function(t){s=s.then((function(){return G(t,a)})).then((function(t){t&&e.appendChild(t)}))})),s}}(e,a,t)})).then((function(t){return function(e,t){return t instanceof Element?Promise.resolve().then(a).then(s).then(i).then(r).then((function(){return t})):t;function a(){function a(e,t){function a(e,t){y.asArray(e).forEach((function(a){t.setProperty(a,e.getPropertyValue(a),e.getPropertyPriority(a))}))}e.cssText?t.cssText=e.cssText:a(e,t)}a(window.getComputedStyle(e),t.style)}function s(){function a(a){const s=window.getComputedStyle(e,a),i=s.getPropertyValue("content");if(""===i||"none"===i)return;const r=y.uid();t.className=t.className+" "+r;const n=document.createElement("style");function o(e,t,a){const s="."+e+":"+t,i=a.cssText?r(a):n(a);return document.createTextNode(s+"{"+i+"}");function r(e){const t=e.getPropertyValue("content");return e.cssText+" content: "+t+";"}function n(e){return y.asArray(e).map(t).join("; ")+";";function t(t){return t+": "+e.getPropertyValue(t)+(e.getPropertyPriority(t)?" !important":"")}}}n.appendChild(o(r,a,s)),t.appendChild(n)}[":before",":after"].forEach((function(e){a(e)}))}function i(){e instanceof HTMLTextAreaElement&&(t.innerHTML=e.value),e instanceof HTMLInputElement&&t.setAttribute("value",e.value)}function r(){t instanceof SVGElement&&(t.setAttribute("xmlns","http://www.w3.org/2000/svg"),t instanceof SVGRectElement&&["width","height"].forEach((function(e){const a=t.getAttribute(e);a&&t.style.setProperty(e,a)})))}}(e,t)})):Promise.resolve()}function O(e){return M.resolveAll().then((function(t){const a=document.createElement("style");return e.appendChild(a),a.appendChild(document.createTextNode(t)),e}))}function B(e){return X.inlineAll(e).then((function(){return e}))}function E(e,t,a){if(a(e,t))for(e=e.firstChild;e;)E(e,t+1,a),e=e.nextSibling}const k='data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg"'.length,L=(e,t,a,s)=>{A.toSvg(e).then((e=>{const i=e.substring(0,k)+` viewBox="0 0 ${t.width} ${t.height}"`+e.substring(k),r=new Image;r.onload=function(){s(r,a)},r.src=i}))},N=new t.Plane(1,1);class H extends t.TreeItem{constructor(e,a){super("VRControllerUI"),this.setSelectable(!1),this.appData=e,this.__vrUIDOMElement=a,this.__vrUIDOMElement.style.display="none";const s=new t.TreeItem("Offset");this.addChild(s,!1),this.ready=!1;const i=new ResizeObserver((e=>{i.disconnect();const r=new t.Xfo,n=5e-4;r.sc.set(n,n,n),r.ori.setFromEulerAngles(new t.EulerAngles(Math.PI,Math.PI,0)),s.getParameter("LocalXfo").setValue(r),this.size=new t.Vec3(a.clientWidth*n,a.clientHeight*n,1),E(a,0,((e,i)=>{if("button"==e.className){const r=function(e){const t=e.computedStyleMap();return{width:t.get("width").value+(t.get("margin-left").value+t.get("margin-right").value),height:t.get("height").value+(t.get("margin-top").value+t.get("margin-bottom").value)}}(e),n=new t.Xfo;n.sc.set(r.width,-r.height,1),n.tr.set(e.offsetLeft+.5*r.width-.5*a.clientWidth,e.offsetTop+.5*r.height-.5*a.clientHeight,-i);const o=new t.Material("element-vr-ui-mat","FlatSurfaceShader");o.getParameter("BaseColor").setValue(new t.Color(.3,.3,.3));const h=new t.DataImage;o.getParameter("BaseColor").setValue(h);const l=new t.GeomItem("element-vr-ui",N,o,n);l.setSelectable(!1),s.addChild(l,!1);const c={};r.width>0&&r.height>0&&L(e,r,e.id+e.className,((e,t)=>{c[t]=e,h.setData(r.width,r.height,e)}));return new MutationObserver((t=>{if(0==r.width||0==r.height)return;const a=e.id+e.className;c[a]?h.setData(r.width,r.height,c[a]):L(e,r,a,((e,t)=>{c[t]=e,h.setData(r.width,r.height,e)}))})).observe(e,{attributes:!0,characterData:!1,childList:!1,subtree:!1}),!1}return!0})),this.ready=!0,this.emit("ready")}));i.observe(a)}activate(){this.__vrUIDOMElement.style.display="block"}deactivate(){this.__vrUIDOMElement.style.display="none"}sendMouseEvent(e,t,a){const s=new MouseEvent(e,Object.assign({target:a,view:window,bubbles:!0,cancelable:!0},t));return a.dispatchEvent(s),s}}class U extends t.BaseTool{constructor(e,a){super(e),this.appData=e,this.__vrUIDOMElement=a,this.controllerUI=new H(e,this.__vrUIDOMElement);const s=new t.Material("pointermat","LinesShader");s.setSelectable(!1),s.getParameter("BaseColor").setValue(new t.Color(1.2,0,0));const i=new t.Lines;i.setNumVertices(2),i.setNumSegments(1),i.setSegmentVertexIndices(0,0,1);const r=i.getVertexAttribute("positions");r.getValueRef(0).set(0,0,0),r.getValueRef(1).set(0,0,-1),i.setBoundingBoxDirty(),this.__pointerLocalXfo=new t.Xfo,this.__pointerLocalXfo.sc.set(1,1,.1),this.__pointerLocalXfo.ori.setFromAxisAndAngle(new t.Vec3(1,0,0),-.2*Math.PI),this.__uiPointerItem=new t.GeomItem("VRControllerPointer",i,s),this.__uiPointerItem.setSelectable(!1),this.__triggerHeld=!1,this.uiOpen=!1,this.appData.renderer.getXRViewport().then((e=>{e.on("presentingChanged",(e=>{this.uiOpen&&!e.state&&this.closeUI()}))}))}getName(){return"VRUITool"}activateTool(){super.activateTool()}deactivateTool(){this.uiOpen&&this.closeUI(),super.deactivateTool()}displayUI(e,a,s){this.controllerUI.activate(),this.uiController=e,this.pointerController=a;const i=this.controllerUI.getParameter("LocalXfo").getValue();if(i.ori.setFromAxisAndAngle(new t.Vec3(1,0,0),-.6*Math.PI),this.pointerController){const e=this.uiController.getTreeItem().getParameter("GlobalXfo").getValue(),t=this.pointerController.getTreeItem().getParameter("GlobalXfo").getValue(),a=e.tr.subtract(s.tr),r=t.tr.subtract(s.tr);a.cross(r).dot(s.ori.getYaxis())>0?i.tr.set(.05,-.05,.08):i.tr.set(-.05,-.05,.08)}else i.tr.set(0,-.05,.08);if(this.controllerUI.getParameter("LocalXfo").setValue(i),this.uiController&&(this.uiController.getTipItem().addChild(this.controllerUI,!1),this.pointerController&&this.pointerController.getTipItem().addChild(this.__uiPointerItem,!1),this.appData.session)){const e=()=>{this.appData.session.pub("pose-message",{interfaceType:"VR",showUIPanel:{controllerId:this.uiController.getId(),localXfo:i.toJSON(),size:this.controllerUI.size.toJSON()}})};this.controllerUI.ready?e():this.controllerUI.on("ready",e)}this.uiOpen=!0}closeUI(){this.controllerUI.deactivate(),this.uiController&&(this.uiController.getTipItem().removeChildByHandle(this.controllerUI),this.pointerController&&this.pointerController.getTipItem().removeChildByHandle(this.__uiPointerItem),this.appData.session&&this.appData.session.pub("pose-message",{interfaceType:"VR",closehideUIPanel:{controllerId:this.uiController.getId()}})),this.uiOpen=!1}setPointerLength(e){this.__pointerLocalXfo.sc.set(1,1,e),this.__uiPointerItem.getParameter("LocalXfo").setValue(this.__pointerLocalXfo)}calcUIIntersection(){const e=this.__uiPointerItem.getParameter("GlobalXfo").getValue(),a=e.ori.getZaxis().negate(),s=new t.Ray(e.tr,a),i=this.controllerUI.getParameter("GlobalXfo").getValue(),r=this.controllerUI.size.multiply(i.sc),n=new t.Ray(i.tr,i.ori.getZaxis().negate()),o=s.intersectRayPlane(n);if(o<=0)return void this.setPointerLength(.5);const h=e.tr.add(a.scale(o)).subtract(n.start),l=h.dot(i.ori.getXaxis())/r.x,c=h.dot(i.ori.getYaxis())/r.y;if(Math.abs(l)>.5||Math.abs(c)>.5)return void this.setPointerLength(.5);this.setPointerLength(o/i.sc.z);const g=this.__vrUIDOMElement.getBoundingClientRect();return{clientX:Math.round(l*-g.width+g.width/2),clientY:Math.round(c*-g.height+g.height/2)}}sendEventToUI(e,t){const a=this.calcUIIntersection();if(a){a.offsetX=a.pageX=a.pageX=a.screenX=a.clientX,a.offsetY=a.pageY=a.pageY=a.screenY=a.clientY;let s=document.elementFromPoint(a.clientX,a.clientY);return s?(s.shadowRoot&&(s=s.shadowRoot.elementFromPoint(a.clientX,a.clientY)),s!=this._element&&(this._element&&this.controllerUI.sendMouseEvent("mouseleave",Object.assign(t,a),this._element),this._element=s,this.controllerUI.sendMouseEvent("mouseenter",Object.assign(t,a),this._element)),this.controllerUI.sendMouseEvent(e,Object.assign(t,a),this._element)):this._element=null,this._element}this._element&&(this.controllerUI.sendMouseEvent("mouseleave",Object.assign(t,a),this._element),this._element=null)}onPointerDown(e){if(e.pointerType===t.POINTER_TYPES.xr&&e.controller==this.pointerController&&this.uiOpen){this.__triggerHeld=!0;const t=this.sendEventToUI("mousedown",{button:e.button-1});this.__triggerDownElem=t||null,e.stopPropagation()}}onPointerUp(e){if(e.pointerType===t.POINTER_TYPES.xr&&e.controller==this.pointerController&&this.uiOpen){this.__triggerHeld=!1;const t=this.sendEventToUI("mouseup",{button:e.button-1});t&&this.__triggerDownElem==t&&this.sendEventToUI("mouseup",{button:e.button-1}),this.__triggerDownElem=null,e.stopPropagation()}}onPointerMove(e){if(e.pointerType===t.POINTER_TYPES.xr)if(this.uiOpen){const t=e.viewXfo;(()=>{const a=this.uiController.getTreeItem().getParameter("GlobalXfo").getValue(),s=a.tr.subtract(t.tr);return s.normalizeInPlace(),!(s.angleTo(a.ori.getYaxis())>.5*Math.PI)||(this.closeUI(),e.getCapture()==this&&e.releaseCapture(this),!1)})()&&this.sendEventToUI("mousemove",{}),e.stopPropagation()}else{if(!e.controllers[0]||e.controllers[0].buttonPressed||!e.controllers[1]||e.controllers[1].buttonPressed)return;const t=e.viewXfo,a=(a,s)=>{const i=a.getTreeItem().getParameter("GlobalXfo").getValue(),r=i.tr.subtract(t.tr);return r.normalizeInPlace(),r.angleTo(i.ori.getYaxis())<.25*Math.PI&&(this.displayUI(a,s,t),e.setCapture(this),e.stopPropagation(),!0)};if(a(e.controllers[0],e.controllers[1]))return;if(a(e.controllers[1],e.controllers[0]))return}}}class z extends n{constructor(e){super("HoldObjectsChange"),this.__selection=[],this.__prevXfos=[],this.__newXfos=[],e&&this.update(e)}undo(){for(let e=0;e<this.__selection.length;e++)this.__selection[e]&&this.__prevXfos[e]&&this.__selection[e].getParameter("GlobalXfo").setValue(this.__prevXfos[e])}redo(){for(let e=0;e<this.__selection.length;e++)this.__selection[e]&&this.__newXfos[e]&&this.__selection[e].getParameter("GlobalXfo").setValue(this.__newXfos[e])}update(e){if(e.newItem)this.__selection[e.newItemId]=e.newItem,this.__prevXfos[e.newItemId]=e.newItem.getParameter("GlobalXfo").getValue();else if(e.changeXfos)for(let t=0;t<e.changeXfoIds.length;t++){const a=e.changeXfoIds[t];this.__selection[a]&&(this.__selection[a].getParameter("GlobalXfo").setValue(e.changeXfos[t]),this.__newXfos[a]=e.changeXfos[t])}this.emit("updated",e)}toJSON(e){const t=super.toJSON(e),a=[];for(let e=0;e<this.__selection.length;e++)this.__selection[e]?a[e]=this.__selection[e].getPath():a.push(null);return t.itemPaths=a,t}fromJSON(e,t){super.fromJSON(e,t);const a=t.appData.scene.getRoot();this.__selection=[];for(let t=0;t<e.itemPaths.length;t++){const s=e.itemPaths[t];if(s&&""!=s){const e=a.resolvePath(s,1);e!=a&&(this.__selection[t]=e,this.__prevXfos[t]=e.getParameter("GlobalXfo").getValue())}}}updateFromJSON(e){this.update(e)}}i.registerChange("HoldObjectsChange",z);class F extends t.BaseTool{constructor(e){super(e),this.appData=e,this.__pressedButtonCount=0,this.__freeIndices=[],this.__vrControllers=[],this.__heldObjectCount=0,this.__heldGeomItems=[],this.__highlightedGeomItemIds=[],this.__heldGeomItemIds=[],this.__heldGeomItemRefs=[],this.__heldGeomItemOffsets=[]}activateTool(){super.activateTool(),this.appData.renderer.getGLCanvas().style.cursor="crosshair";const e=e=>{this.__activated};this.appData.renderer.getXRViewport().then((t=>{for(const a of t.getControllers())e();this.addIconToControllerId=t.on("controllerAdded",(t=>e(t.controller)))}))}deactivateTool(){super.deactivateTool(),this.appData.renderer.getXRViewport().then((e=>{e.removeListenerById("controllerAdded",this.addIconToControllerId)}))}computeGrabXfo(e){let a;if(1==e.length)a=this.__vrControllers[e[0]].getTipXfo();else if(2==e.length){const s=this.__vrControllers[e[0]].getTipXfo(),i=this.__vrControllers[e[1]].getTipXfo();s.ori.alignWith(i.ori),a=new t.Xfo,a.tr=s.tr.lerp(i.tr,.5),a.ori=s.ori.lerp(i.ori,.5);let r=i.tr.subtract(s.tr);r.normalizeInPlace();const n=a.ori.getXaxis();r.dot(n)<0&&(r=r.negate());const o=r.angleTo(n);if(o>0){const e=n.cross(r);e.normalizeInPlace();const s=new t.Quat;s.setFromAxisAndAngle(e,o),a.ori=s.multiply(a.ori)}}return a}initAction(){for(let e=0;e<this.__heldGeomItems.length;e++){const t=this.__heldGeomItems[e];if(!t)continue;const a=this.computeGrabXfo(this.__heldGeomItemRefs[e]);this.__heldGeomItemOffsets[e]=a.inverse().multiply(t.getParameter("GlobalXfo").getValue())}}onPointerDown(e){if(e.pointerType===t.POINTER_TYPES.xr){const t=e.controller.getId();this.__vrControllers[t]=e.controller;const a=this.__highlightedGeomItemIds[t];if(a){let s=this.__heldGeomItems.indexOf(a);if(-1==s){s=this.__heldGeomItems.length,this.__heldObjectCount++,this.__heldGeomItems.push(a),this.__heldGeomItemRefs[s]=[t],this.__heldGeomItemIds[t]=s;const e={newItem:a,newItemId:s};this.change?this.change.update(e):(this.change=new z(e),i.getInstance().addChange(this.change))}else this.__heldGeomItemIds[t]=s,this.__heldGeomItemRefs[s].push(t);this.initAction(),e.stopPropagation()}}}onPointerUp(e){if(e.pointerType===t.POINTER_TYPES.xr){const t=e.controller.getId();if(this.__pressedButtonCount--,void 0!==this.__heldGeomItemIds[t]){const a=this.__heldGeomItemIds[t],s=this.__heldGeomItemRefs[a];s.splice(s.indexOf(t),1),0==s.length&&(this.__heldObjectCount--,this.__heldGeomItems[a]=void 0,this.change=void 0),this.__heldGeomItemIds[t]=void 0,this.initAction(),e.stopPropagation()}}}onPointerMove(e){if(e.pointerType===t.POINTER_TYPES.xr){if(!this.change)return void e.controllers.forEach((e=>{const a=e.getId(),s=e.getGeomItemAtTip();if(s){const e=s.geomItem;this.__highlightedGeomItemIds[a]!=e&&(this.__highlightedGeomItemIds[a]&&this.__highlightedGeomItemIds[a].removeHighlight("vrHoldObject"),e.addHighlight("vrHoldObject",new t.Color(1,0,0,.2)),this.__highlightedGeomItemIds[a]=e)}else if(this.__highlightedGeomItemIds[a]){this.__highlightedGeomItemIds[a].removeHighlight("vrHoldObject"),this.__highlightedGeomItemIds[a]=null}}));const a=[],s=[];for(let e=0;e<this.__heldGeomItems.length;e++){if(!this.__heldGeomItems[e])continue;const t=this.computeGrabXfo(this.__heldGeomItemRefs[e]);a.push(t.multiply(this.__heldGeomItemOffsets[e])),s.push(e)}this.change.update({changeXfos:a,changeXfoIds:s}),e.stopPropagation()}}onPointerDoublePress(e){e.pointerType,t.POINTER_TYPES.xr}}class J extends t.BaseTool{constructor(e){super(e)}}class j extends J{constructor(e){super(e),e||console.error("App data not provided to tool"),this.appData=e,this.stage=0,this.removeToolOnRightClick=!0,this.parentItem="parentItem"in e?e.parentItem:e.scene.getRoot(),this.colorParam=this.addParameter(new t.ColorParameter("Color",new t.Color(.7,.2,.2))),this.controllerAddedHandler=this.controllerAddedHandler.bind(this)}addIconToVRController(e){this.vrControllerToolTip||(this.vrControllerToolTip=new t.Cross(.05),this.vrControllerToolTipMat=new t.Material("VRController Cross","LinesShader"),this.vrControllerToolTipMat.getParameter("BaseColor").setValue(this.colorParam.getValue()),this.vrControllerToolTipMat.setSelectable(!1));const a=new t.GeomItem("CreateGeomToolTip",this.vrControllerToolTip,this.vrControllerToolTipMat);a.setSelectable(!1),e.getTipItem().addChild(a,!1)}controllerAddedHandler(e){this.addIconToVRController(e.controller)}activateTool(){super.activateTool(),this.prevCursor=this.appData.renderer.getGLCanvas().style.cursor,this.appData.renderer.getGLCanvas().style.cursor="crosshair",this.appData.renderer.getXRViewport().then((e=>{for(const t of e.getControllers())this.addIconToVRController(t);e.on("controllerAdded",this.controllerAddedHandler)}))}deactivateTool(){super.deactivateTool(),this.appData.renderer.getGLCanvas().style.cursor=this.prevCursor,this.appData.renderer.getXRViewport().then((e=>{e.off("controllerAdded",this.controllerAddedHandler)}))}screenPosToXfo(e){if(e.intersectionData){const t=e.pointerRay,a=this.constructionPlane.clone();return a.tr=t.pointAtDist(e.intersectionData.dist),a}const a=e.pointerRay,s=new t.Ray(this.constructionPlane.tr,this.constructionPlane.ori.getZaxis()),i=a.intersectRayPlane(s);if(i>0){const e=this.constructionPlane.clone();return e.tr=a.pointAtDist(i),e}const r=e.viewport.getCamera(),n=r.getParameter("GlobalXfo").getValue().clone();return n.tr=a.pointAtDist(r.getFocalDistance()),n}createStart(e){this.stage=1}createPoint(e){}createMove(e){}createRelease(e){}onPointerDown(e){if(e.pointerType===t.POINTER_TYPES.xr)this.onVRControllerButtonDown(e);else{if(e.altKey)return;if(0==this.stage)if(0==e.button||"mouse"!==e.pointerType){this.constructionPlane=new t.Xfo;const a=this.screenPosToXfo(e);this.createStart(a),e.stopPropagation()}else e.button;else 2==e.button&&(i.getInstance().cancel(),this.stage=0);e.stopPropagation(),e.preventDefault()}}onPointerMove(e){if(e.pointerType===t.POINTER_TYPES.xr)this.onVRPoseChanged(e);else if(this.stage>0){const t=this.screenPosToXfo(e);this.createMove(t.tr),e.stopPropagation(),e.preventDefault()}}onPointerUp(e){if(e.pointerType===t.POINTER_TYPES.xr)this.onVRControllerButtonUp(e);else if(this.stage>0){const t=this.screenPosToXfo(e);this.createRelease(t.tr),e.stopPropagation()}}onWheel(e){}onKeyPressed(e){}onKeyDown(e){}onKeyUp(e){}onTouchCancel(e){}onVRControllerButtonDown(e){if(!this.__activeController){this.__activeController=e.controller,this.constructionPlane=new t.Xfo;const a=this.constructionPlane.clone();a.tr=this.__activeController.getTipXfo().tr,this.createStart(a,this.appData.scene.getRoot())}e.stopPropagation()}onVRPoseChanged(e){if(this.__activeController&&this.stage>0){const t=this.__activeController.getTipXfo();this.createMove(t.tr),e.stopPropagation()}}onVRControllerButtonUp(e){if(this.stage>0&&this.__activeController==e.controller){const t=this.__activeController.getTipXfo();this.createRelease(t.tr),0==this.stage&&(this.__activeController=void 0),e.stopPropagation()}}}class Z extends n{constructor(e){super(e)}setParentAndXfo(e,t){this.parentItem=e;const a=this.parentItem.generateUniqueName(this.geomItem.getName());this.geomItem.setName(a),this.geomItem.getParameter("GlobalXfo").setValue(t),this.parentItem.addChild(this.geomItem)}undo(){this.parentItem.removeChild(this.parentItem.getChildIndex(this.geomItem))}redo(){this.parentItem.addChild(this.geomItem,!1,!1)}toJSON(e){const t=super.toJSON(e);t.parentItemPath=this.parentItem.getPath(),t.geomItemName=this.geomItem.getName(),t.geomItemXfo=this.geomItem.getParameter("LocalXfo").getValue();const a=this.geomItem.getParameter("Material").getValue();return t.color=a.getParameter("BaseColor").getValue(),t}fromJSON(e,a){const s=a.appData.scene.getRoot();this.parentItem=s.resolvePath(e.parentItemPath,1),this.geomItem.setName(this.parentItem.generateUniqueName(e.geomItemName));const i=new t.Xfo;if(i.fromJSON(e.geomItemXfo),this.geomItem.getParameter("LocalXfo").setValue(i),this.childIndex=this.parentItem.addChild(this.geomItem,!1),e.color){const a=new t.Color(.7,.2,.2);a.fromJSON(e.color);this.geomItem.getParameter("Material").getValue().getParameter("BaseColor").setValue(a)}}destroy(){}}class K extends Z{constructor(e,a,s,i){super("Create Line"),this.line=new t.Lines(0),this.line.setNumVertices(2),this.line.setNumSegments(1),this.line.setSegmentVertexIndices(0,0,1);const r=new t.Material("Line","FatLinesShader");r.getParameter("BaseColor").setValue(new t.Color(.7,.2,.2)),this.geomItem=new t.GeomItem("Line",this.line,r),s&&r.getParameter("BaseColor").setValue(s),i&&(this.line.lineThickness=i),e&&a&&this.setParentAndXfo(e,a)}update(e){e.p1&&(this.line.getVertexAttribute("positions").getValueRef(1).setFromOther(e.p1),this.line.emit("geomDataChanged")),this.emit("updated",e)}fromJSON(e,a){if(super.fromJSON(e,a),e.color){const a=new t.Color;a.fromJSON(e.color),material.getParameter("BaseColor").setValue(a)}e.thickness&&(this.line.lineThickness=e.thickness)}}i.registerChange("CreateLineChange",K);class Y extends j{constructor(e){super(e),this.lineThickness=this.addParameter(new t.NumberParameter("LineThickness",.01,[0,.1]))}createStart(e){this.change=new K(this.parentItem,e),i.getInstance().addChange(this.change),this.xfo=e.inverse(),this.stage=1,this.length=0}createMove(e){const t=this.xfo.transformVec3(e);this.length=t.length(),this.change.update({p1:t})}createRelease(e){0==this.length&&i.getInstance().cancel(),this.stage=0,this.emit("actionFinished")}onVRControllerButtonDown(e){if(0==this.stage){const t=e.viewport.__stageScale;this.lineThickness.setValue(.003*t)}super.onVRControllerButtonDown(e)}}class W extends Z{constructor(e,a,s){super("Create Cone");const i=new t.Cone(0,0),r=new t.Material("Cone","SimpleSurfaceShader");this.geomItem=new t.GeomItem("Cone",i,r),e&&a&&(r.getParameter("BaseColor").setValue(s),this.setParentAndXfo(e,a))}update(e){e.radius&&this.geomItem.getParameter("Geometry").getValue().getParameter("Radius").setValue(e.radius),e.height&&this.geomItem.getParameter("Geometry").getValue().getParameter("Height").setValue(e.height),this.emit("updated",e)}}i.registerChange("CreateConeChange",W);class $ extends Z{constructor(e,a){super("CreateCircle"),this.circle=new t.Circle(0,64),this.circle.lineThickness=.05;const s=new t.Material("circle","FatLinesShader");s.getParameter("BaseColor").setValue(new t.Color(.7,.2,.2)),this.geomItem=new t.GeomItem("Circle",this.circle,s),e&&a&&this.setParentAndXfo(e,a)}update(e){this.circle.getParameter("Radius").setValue(e.radius),this.emit("updated",e)}toJSON(){const e=super.toJSON();return e.radius=this.circle.getParameter("Radius").getValue(),e}updateFromJSON(e){console.log("CreateCircleChange:",e),e.radius&&this.circle.getParameter("Radius").setValue(e.radius)}}i.registerChange("CreateCircleChange",$);class q extends Z{constructor(e,a){super("CreateRect"),this.rect=new t.Rect(0,0),this.rect.lineThickness=.05;const s=new t.Material("circle","FatLinesShader");s.getParameter("BaseColor").setValue(new t.Color(.7,.2,.2)),this.geomItem=new t.GeomItem("Rect",this.rect,s),e&&a&&this.setParentAndXfo(e,a)}update(e){if(e.baseSize&&(this.rect.getParameter("X").setValue(e.baseSize[0]),this.rect.getParameter("Y").setValue(e.baseSize[1])),e.tr){const t=this.geomItem.getParameter("LocalXfo").getValue();t.tr.fromJSON(e.tr),this.geomItem.getParameter("LocalXfo").setValue(t)}this.emit("updated",e)}}i.registerChange("CreateRectChange",q);class Q extends Z{constructor(e,a,s,i=.001){super("CreateFreehandLine"),this.used=0,this.vertexCount=100,this.line=new t.Lines,this.line.setNumVertices(this.vertexCount),this.line.setNumSegments(this.vertexCount-1),this.line.getVertexAttribute("positions").setValue(0,new t.Vec3),this.line.lineThickness=i;const r=new t.Material("freeHandLine","FatLinesShader");r.getParameter("LineThickness").setValue(i),s&&r.getParameter("BaseColor").setValue(s),this.geomItem=new t.GeomItem("freeHandLine",this.line,r),e&&a&&this.setParentAndXfo(e,a)}update(e){this.used++;let t=!1;this.used>=this.line.getNumSegments()&&(this.vertexCount=this.vertexCount+100,this.line.setNumVertices(this.vertexCount),this.line.setNumSegments(this.vertexCount-1),t=!0),this.line.getVertexAttribute("positions").setValue(this.used,e.point),this.line.setSegmentVertexIndices(this.used-1,this.used-1,this.used),t?this.line.emit("geomDataTopologyChanged",{topologyChanged:!0}):this.line.emit("geomDataChanged",{topologyChanged:!0}),this.emit("updated",e)}toJSON(e){const t=super.toJSON(e);t.lineThickness=this.line.lineThickness;const a=this.geomItem.getParameter("Material").getValue();return t.color=a.getParameter("BaseColor").getValue(),t}fromJSON(e,a){if(e.lineThickness&&(this.line.lineThickness=e.lineThickness,this.geomItem.getMaterial().getParameter("LineThickness").setValue(e.lineThickness)),e.color){const a=new t.Color(.7,.2,.2);a.fromJSON(e.color),this.geomItem.getMaterial().getParameter("BaseColor").setValue(a)}super.fromJSON(e,a)}}i.registerChange("CreateFreehandLineChange",Q);class ee extends Z{constructor(e,a,s){super("CreateSphere",e),this.sphere=new t.Sphere(0,24,12);const i=new t.Material("Sphere","SimpleSurfaceShader");this.geomItem=new t.GeomItem("Sphere",this.sphere,i),e&&a&&s&&(i.getParameter("BaseColor").setValue(s),this.setParentAndXfo(e,a))}update(e){this.sphere.getParameter("Radius").setValue(e.radius),this.emit("updated",e)}toJSON(){const e=super.toJSON();return e.radius=this.sphere.getParameter("Radius").getValue(),e}updateFromJSON(e){e.radius&&this.sphere.getParameter("Radius").setValue(e.radius)}}i.registerChange("CreateSphereChange",ee);class te extends Z{constructor(e,a,s){super("CreateCuboid"),this.cuboid=new t.Cuboid(0,0,0,!0);const i=new t.Material("Cuboid","SimpleSurfaceShader");this.geomItem=new t.GeomItem("Cuboid",this.cuboid,i),e&&a&&(i.getParameter("BaseColor").setValue(s),this.setParentAndXfo(e,a))}update(e){if(e.baseSize&&this.cuboid.setBaseSize(e.baseSize[0],e.baseSize[1]),e.tr){const t=this.geomItem.getParameter("LocalXfo").getValue();t.tr.fromJSON(e.tr),this.geomItem.getParameter("LocalXfo").setValue(t)}e.height&&this.cuboid.getParameter("Z").setValue(e.height),this.emit("updated",e)}}i.registerChange("CreateCuboidChange",te);class ae extends t.BaseTool{constructor(){super(),this.tools={},this.toolStack=[]}registerTool(e,t){this.tools[e]=t}pushTool(e){const t=this.tools[e];if(!t)throw Error("Tool not found",e);t.activateTool&&t.activateTool(),this.toolStack.push(this.tools[e])}popTool(){if(0==this.toolStack.length)throw Error("Tool stack is empty");const e=this.toolStack[this.toolStack.length-1];e.deactivateTool&&e.deactivateTool(),this.toolStack.pop()}activeTool(){return this.toolStack.length>0?this.toolStack[this.toolStack.length-1]:""}activeToolName(){if(this.toolStack.length>0){const e=this.toolStack[this.toolStack.length-1];for(const t in this.tools)if(this.tools[t]==e)return t}return""}onPointerDown(e){for(let t=this.toolStack.length-1;t>=0;t--){const a=this.toolStack[t];if(a.onPointerDown&&(a.onPointerDown(e),!e.propagating))break}}onPointerMove(e){for(let t=this.toolStack.length-1;t>=0;t--){const a=this.toolStack[t];if(a.onPointerMove&&(a.onPointerMove(e),!e.propagating))break}}onPointerUp(e){for(let t=this.toolStack.length-1;t>=0;t--){const a=this.toolStack[t];if(a.onPointerUp&&(a.onPointerUp(e),!e.propagating))break}}onPointerDoublePress(e){for(let t=this.toolStack.length-1;t>=0;t--){const a=this.toolStack[t];if(a.onPointerDoublePress&&(a.onPointerDoublePress(e),!e.propagating))break}}onWheel(e){for(let t=this.toolStack.length-1;t>=0;t--){const a=this.toolStack[t];if(a.onWheel&&(a.onWheel(e),!e.propagating))break}}onKeyPressed(e){for(let t=this.toolStack.length-1;t>=0;t--){const a=this.toolStack[t];if(a.onKeyPressed&&(a.onKeyPressed(e),!e.propagating))break}}onKeyDown(e){for(let t=this.toolStack.length-1;t>=0;t--){const a=this.toolStack[t];if(a.onKeyDown&&(a.onKeyDown(e),!e.propagating))break}}onKeyUp(e){for(let t=this.toolStack.length-1;t>=0;t--){const a=this.toolStack[t];if(a.onKeyUp&&(a.onKeyUp(e),!e.propagating))break}}}class se extends s{constructor(e,a=.5,s=.02,i=new t.Color("#F9CE03")){super(e),this.lengthParam=this.addParameter(new t.NumberParameter("Length",a)),this.handleRadiusParam=this.addParameter(new t.NumberParameter("HandleRadius",s)),this.barRadiusParam=this.addParameter(new t.NumberParameter("BarRadius",.25*s)),this.colorParam.setValue(i),this.handleMat=new t.Material("handle","FlatSurfaceShader"),this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue());const r=new t.Material("topBar","FlatSurfaceShader");r.getParameter("BaseColor").setValue(new t.Color(.5,.5,.5));const n=new t.Cylinder(.25*s,1,64,2,!0,!0),o=new t.Sphere(s,64);this.handle=new t.GeomItem("handle",o,this.handleMat),this.baseBar=new t.GeomItem("baseBar",n,this.handleMat),this.topBar=new t.GeomItem("topBar",n,r),this.handleXfo=new t.Xfo,this.baseBarXfo=new t.Xfo,this.topBarXfo=new t.Xfo,this.barRadiusParam.on("valueChanged",(()=>{n.getParameter("Radius").setValue(this.barRadiusParam.getValue())})),this.handleRadiusParam.on("valueChanged",(()=>{o.getParameter("Radius").setValue(this.handleRadiusParam.getValue())})),this.lengthParam.on("valueChanged",(()=>{this.__updateSlider(this.value)})),this.colorParam.on("valueChanged",(()=>{this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())})),this.addChild(this.handle),this.addChild(this.baseBar),this.addChild(this.topBar),this.__updateSlider(0)}highlight(){super.highlight(),this.handleMat.getParameter("BaseColor").setValue(this.highlightColorParam.getValue())}unhighlight(){super.unhighlight(),this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())}setTargetParam(e){this.param=e;const t=()=>{this.__updateSlider(e.getValue())};t(),e.on("valueChanged",t)}__updateSlider(e){this.value=e;const a=this.param&&this.param.getRange()?this.param.getRange():[0,1],s=t.MathFunctions.remap(e,a[0],a[1],0,1),i=this.lengthParam.getValue();this.baseBarXfo.sc.z=s*i,this.handleXfo.tr.z=s*i,this.topBarXfo.tr.z=s*i,this.topBarXfo.sc.z=(1-s)*i,this.handle.getParameter("LocalXfo").setValue(this.handleXfo),this.baseBar.getParameter("LocalXfo").setValue(this.baseBarXfo),this.topBar.getParameter("LocalXfo").setValue(this.topBarXfo)}onDragStart(e){this.handleXfo.sc.x=this.handleXfo.sc.y=this.handleXfo.sc.z=1.2,this.handle.getParameter("LocalXfo").setValue(this.handleXfo),this.param&&(this.change=new o(this.param),i.getInstance().addChange(this.change))}onDrag(e){const a=this.lengthParam.getValue(),s=this.param&&this.param.getRange()?this.param.getRange():[0,1],i=t.MathFunctions.clamp(t.MathFunctions.remap(e.value,0,a,s[0],s[1]),s[0],s[1]);if(!this.param)return this.__updateSlider(i),void(this.value=i);this.change.update({value:i})}onDragEnd(e){this.change=null,this.handleXfo.sc.x=this.handleXfo.sc.y=this.handleXfo.sc.z=1,this.handle.getParameter("LocalXfo").setValue(this.handleXfo)}toJSON(e){const t=super.toJSON(e);return this.param&&(t.targetParam=this.param.getPath()),t}fromJSON(e,t){super.fromJSON(e,t),e.targetParam&&t.resolvePath(e.targetParam).then((e=>{this.setTargetParam(e)}))}}t.Registry.register("SliderHandle",se);class ie extends g{constructor(e,a=1,s=1,i=.02,r=new t.Color(1,1,0)){super(e),this.arcRadiusParam=this.addParameter(new t.NumberParameter("ArcRadius",a)),this.arcAngleParam=this.addParameter(new t.NumberParameter("ArcAngle",s)),this.handleRadiusParam=this.addParameter(new t.NumberParameter("HandleRadius",i)),this.colorParam.setValue(r),this.handleMat=new t.Material("handleMat","HandleShader"),this.handleMat.getParameter("BaseColor").setValue(r);const n=new t.Circle(a,64,s),o=new t.Sphere(i,64);this.handle=new t.GeomItem("handle",o,this.handleMat),this.arc=new t.GeomItem("arc",n,this.handleMat),this.handleXfo=new t.Xfo,this.handleGeomOffsetXfo=new t.Xfo,this.handleGeomOffsetXfo.tr.x=a,this.handle.getParameter("GeomOffsetXfo").setValue(this.handleGeomOffsetXfo),this.range=[0,s],this.arcAngleParam.on("valueChanged",(()=>{const e=this.arcAngleParam.getValue();n.getParameter("Angle").setValue(e),this.range=[0,e]})),this.arcRadiusParam.on("valueChanged",(()=>{const e=this.arcRadiusParam.getValue();n.getParameter("Radius").setValue(e),this.handleGeomOffsetXfo.tr.x=e,this.handle.getParameter("GeomOffsetXfo").setValue(this.handleGeomOffsetXfo)})),this.handleRadiusParam.on("valueChanged",(()=>{o.getParameter("Radius").setValue(this.handleRadiusParam.getValue())})),this.colorParam.on("valueChanged",(()=>{this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())})),this.addChild(this.handle),this.addChild(this.arc),this.setTargetParam(this.handle.getParameter("GlobalXfo"),!1)}onPointerEnter(e){e.intersectionData&&e.intersectionData.geomItem==this.handle&&this.highlight()}onPointerLeave(e){this.unhighlight()}onPointerDown(e){e.intersectionData&&e.intersectionData.geomItem==this.handle&&super.onPointerDown(e)}highlight(){super.highlight(),this.handleMat.getParameter("BaseColor").setValue(this.highlightColorParam.getValue())}unhighlight(){super.unhighlight(),this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())}setTargetParam(e,a=!0){if(this.param=e,a)if(this.param instanceof t.XfoParameter){const t=()=>{this.getParameter("GlobalXfo").setValue(e.getValue())};t(),e.on("valueChanged",t)}else if(this.param instanceof t.NumberParameter){const a=()=>{this.handleXfo.ori.setFromAxisAndAngle(new t.Vec3(0,0,1),e.getValue()),this.handle.getParameter("GlobalXfo").setValue(this.handleXfo)};a(),e.on("valueChanged",a)}}getBaseXfo(){return this.handle.getParameter("GlobalXfo").getValue()}onDragStart(e){this.baseXfo=this.getParameter("GlobalXfo").getValue().clone(),this.baseXfo.sc.set(1,1,1),this.deltaXfo=new t.Xfo,this.vec0=this.getParameter("GlobalXfo").getValue().ori.getXaxis(),this.vec0.normalizeInPlace(),this.change=new o(this.param),i.getInstance().addChange(this.change),this.handleGeomOffsetXfo.sc.x=this.handleGeomOffsetXfo.sc.y=this.handleGeomOffsetXfo.sc.z=1.2,this.handle.getParameter("GeomOffsetXfo").setValue(this.handleGeomOffsetXfo),this.emit("dragStart")}onDrag(e){const a=e.holdPos.subtract(this.baseXfo.tr);a.normalizeInPlace();let s=this.vec0.angleTo(a);if(this.vec0.cross(a).dot(this.baseXfo.ori.getZaxis())<0&&(s=-s),this.range&&(s=t.MathFunctions.clamp(s,this.range[0],this.range[1])),e.shiftKey){const e=Math.degToRad(22.5);s=Math.floor(s/e)*e}this.deltaXfo.ori.setFromAxisAndAngle(new t.Vec3(0,0,1),s);const i=this.baseXfo.multiply(this.deltaXfo);this.change?this.param instanceof t.XfoParameter?this.change.update({value:i}):this.param instanceof t.NumberParameter&&this.change.update({value:s}):this.param instanceof t.XfoParameter?this.param.setValue(i):this.param instanceof t.NumberParameter&&this.param.setValue(s)}onDragEnd(e){this.change=null,this.handleGeomOffsetXfo.sc.x=this.handleGeomOffsetXfo.sc.y=this.handleGeomOffsetXfo.sc.z=1,this.handle.getParameter("GeomOffsetXfo").setValue(this.handleGeomOffsetXfo),this.emit("dragEnd")}toJSON(e){const t=super.toJSON(e);return this.param&&(t.targetParam=this.param.getPath()),t}fromJSON(e,t){super.fromJSON(e,t),e.targetParam&&t.resolvePath(e.targetParam).then((e=>{this.setTargetParam(e)}))}}t.Registry.register("ArcSlider",ie);const re=new t.Sphere(.003),ne=new t.Lines(0);ne.setNumVertices(2),ne.setNumSegments(1),ne.setSegmentVertexIndices(0,0,1),ne.getVertexAttribute("positions").getValueRef(1).setFromOther(new t.Vec3(0,0,1));class oe extends t.TreeItem{constructor(e="MeasureDistance",a=new t.Color("#F9CE03")){super(e),this.colorParam=this.addParameter(new t.ColorParameter("Color",a)),this.unitsParameter=this.addParameter(new t.StringParameter("Units","mm")),this.markerMaterial=new t.Material("Marker","HandleShader"),this.markerMaterial.getParameter("BaseColor").setValue(this.colorParam.getValue()),this.markerMaterial.getParameter("MaintainScreenSize").setValue(1),this.markerMaterial.getParameter("Overlay").setValue(.5),this.lineMaterial=new t.Material("Line","LinesShader"),this.lineMaterial.getParameter("BaseColor").setValue(this.colorParam.getValue()),this.lineMaterial.getParameter("Overlay").setValue(.5),this.startMarker=new t.GeomItem(`${e}StartMarker`,re,this.markerMaterial),this.endMarker=new t.GeomItem(`${e}EndMarker`,re,this.markerMaterial),this.addChild(this.startMarker),this.addChild(this.endMarker),this.lineGeomItem=new t.GeomItem("Line",ne,this.lineMaterial),this.lineGeomItem.setSelectable(!1),this.addChild(this.lineGeomItem),this.label=new t.Label("Distance"),this.label.getParameter("FontSize").setValue(20),this.label.getParameter("BackgroundColor").setValue(this.colorParam.getValue()),this.billboard=new t.BillboardItem("DistanceBillboard",this.label),this.billboard.getParameter("LocalXfo").setValue(new t.Xfo),this.billboard.getParameter("PixelsPerMeter").setValue(1500),this.billboard.getParameter("AlignedToCamera").setValue(!0),this.billboard.getParameter("DrawOnTop").setValue(!0),this.billboard.getParameter("FixedSizeOnscreen").setValue(!0),this.billboard.getParameter("Alpha").setValue(1),this.addChild(this.billboard),this.colorParam.on("valueChanged",(()=>{const e=this.colorParam.getValue();this.markerMaterial.getParameter("BaseColor").setValue(e),this.lineMaterial.getParameter("BaseColor").setValue(e),this.label.getParameter("BackgroundColor").setValue(e)}))}updateMeasurement(){const e=this.startMarker.getParameter("GlobalXfo").getValue(),a=this.endMarker.getParameter("GlobalXfo").getValue().tr.subtract(e.tr),s=a.length(),i=e.clone();i.ori.setFromDirectionAndUpvector(a,new t.Vec3(a.z,a.x,a.y)),i.sc.z=s,this.lineGeomItem.getParameter("GlobalXfo").setValue(i);const r=1e3*s;this.label.getParameter("Text").setValue(`${parseFloat(r.toFixed(4))}${this.unitsParameter.getValue()}`),a.normalizeInPlace();const n=e.tr.add(a.scale(.5*s)),o=new t.Xfo(n);o.ori.setFromDirectionAndUpvector(a,new t.Vec3(a.z,a.x,a.y)),this.billboard.getParameter("GlobalXfo").setValue(o)}setStartMarkerPos(e){const t=this.startMarker.getParameter("GlobalXfo").getValue();t.tr=e,this.startMarker.getParameter("GlobalXfo").setValue(t),this.updateMeasurement()}setEndMarkerPos(e){const t=this.endMarker.getParameter("GlobalXfo").getValue();t.tr=e,this.endMarker.getParameter("GlobalXfo").setValue(t),this.updateMeasurement()}setGeomBuffersVisibility(e){this.startMarker.setSelectable(!e),this.endMarker.setSelectable(!e)}getMeasurementText(){return this.label.getParameter("Text").getValue()}}t.Registry.register("MeasureDistance",oe);const he=new t.Sphere(.003,24,12,!1),le=new t.Lines(0);le.setNumVertices(2),le.setNumSegments(1),le.setSegmentVertexIndices(0,0,1),le.getVertexAttribute("positions").getValueRef(1).setFromOther(new t.Vec3(0,0,1));class ce extends t.TreeItem{constructor(e="MeasureAngle",a=new t.Color("#00AA00")){super(e),this.colorParam=this.addParameter(new t.ColorParameter("Color",a)),this.markerMaterial=new t.Material("Marker","HandleShader"),this.markerMaterial.getParameter("BaseColor").setValue(this.colorParam.getValue()),this.markerMaterial.getParameter("MaintainScreenSize").setValue(1),this.markerMaterial.getParameter("Overlay").setValue(.5),this.markerMaterialB=new t.Material("Marker","HandleShader"),this.markerMaterialB.getParameter("BaseColor").setValue(new t.Color(1,0,0)),this.markerMaterialB.getParameter("MaintainScreenSize").setValue(1),this.markerMaterialB.getParameter("Overlay").setValue(.5),this.lineMaterial=new t.Material("Line","LinesShader"),this.lineMaterial.getParameter("BaseColor").setValue(this.colorParam.getValue()),this.lineMaterial.getParameter("Overlay").setValue(.5),this.markerA=new t.GeomItem("markerA",he,this.markerMaterial),this.markerB=new t.GeomItem("markerB",he,this.markerMaterialB),this.addChild(this.markerA),this.addChild(this.markerB)}createLinesAndLabel(){this.markerA.addChild(new t.GeomItem("Line",le,this.lineMaterial),!1),this.markerB.addChild(new t.GeomItem("Line",le,this.lineMaterial),!1),this.label=new t.Label("Distance"),this.label.getParameter("FontSize").setValue(20),this.label.getParameter("BackgroundColor").setValue(this.colorParam.getValue()),this.billboard=new t.BillboardItem("DistanceBillboard",this.label),this.billboard.getParameter("LocalXfo").setValue(new t.Xfo),this.billboard.getParameter("PixelsPerMeter").setValue(1500),this.billboard.getParameter("AlignedToCamera").setValue(!0),this.billboard.getParameter("DrawOnTop").setValue(!0),this.billboard.getParameter("FixedSizeOnscreen").setValue(!0),this.billboard.getParameter("Alpha").setValue(1),this.addChild(this.billboard),this.colorParam.on("valueChanged",(()=>{const e=this.colorParam.getValue();this.markerMaterial.getParameter("BaseColor").setValue(e),this.lineMaterial.getParameter("BaseColor").setValue(e),this.label.getParameter("BackgroundColor").setValue(e)}));const e=this.markerA.getParameter("GlobalXfo").getValue(),a=this.markerB.getParameter("GlobalXfo").getValue(),s=e.ori.getZaxis(),i=a.ori.getZaxis(),r=s.cross(i).normalize(),n=r.cross(s).normalize(),o=r.cross(i).normalize(),h=new t.Ray(e.tr,n),l=new t.Ray(a.tr,o),c=h.intersectRayVector(l),g=n.angleTo(o),d=new t.Xfo;d.tr.addInPlace(h.pointAtDist(c[0])),d.tr.addInPlace(l.pointAtDist(c[1])),d.tr.scaleInPlace(.5),e.ori.setFromDirectionAndUpvector(n,s),this.markerA.getParameter("GlobalXfo").setValue(e),a.ori.setFromDirectionAndUpvector(o,s),this.markerB.getParameter("GlobalXfo").setValue(a);const u=new t.Xfo;u.sc.z=c[0],this.markerA.getChild(0).getParameter("LocalXfo").setValue(u);const m=new t.Xfo;m.sc.z=c[1],this.markerB.getChild(0).getParameter("LocalXfo").setValue(m),this.label.getParameter("Text").setValue(`${(g/(Math.PI/180)).toFixed(3)} `),this.billboard.getParameter("GlobalXfo").setValue(d)}setXfoA(e){this.markerA.getParameter("GlobalXfo").setValue(e),this.markerB.getParameter("GlobalXfo").setValue(e)}getXfoA(){return this.markerA.getParameter("GlobalXfo").getValue()}setXfoB(e){this.markerB.getParameter("GlobalXfo").setValue(e),this.createLinesAndLabel()}}t.Registry.register("MeasureAngle",ce);class ge extends n{constructor(e){super("MeasurementChange"),e&&(this.measurement=e)}update(e){this.measurement.fromJSON(e.measurementData),this.emit("updated",e)}end(){this.measurement.setGeomBuffersVisibility(!0)}undo(){console.log("undo MeasurementChange"),this.parentItem=this.measurement.getOwner(),this.childIndex=this.parentItem.getChildIndex(this.measurement),this.parentItem.removeChild(this.childIndex)}redo(){console.log("redo MeasurementChange"),this.parentItem.insertChild(this.measurement,this.childIndex)}toJSON(e){const a=super.toJSON(e);return a.parentItemPath=this.measurement.getOwner().getPath(),a.measurementType=t.Registry.getBlueprintName(this.measurement),a.measurementData=this.measurement.toJSON(e),a}fromJSON(e,a){const s=a.appData.scene.getRoot().resolvePath(e.parentItemPath,1);s&&(this.measurement=t.Registry.constructBlueprintName(e.measurementType),this.measurement.fromJSON(e.measurementData),s.addChild(this.measurement))}destroy(){}}i.registerChange("MeasurementChange",ge);class de extends t.BaseTool{constructor(e){super(),this.colorParam=this.addParameter(new t.ColorParameter("Color",new t.Color("#F9CE03"))),e||console.error("App data not provided to tool"),this.appData=e,this.measurementChange=null,this.highlightedItemA=null,this.highlightedItemB=null,this.stage=0}activateTool(){super.activateTool(),this.appData&&this.appData.renderer&&(this.prevCursor=this.appData.renderer.getGLCanvas().style.cursor,this.appData.renderer.getGLCanvas().style.cursor="crosshair")}deactivateTool(){if(super.deactivateTool(),this.appData&&this.appData.renderer&&(this.appData.renderer.getGLCanvas().style.cursor=this.prevCursor),0!=this.stage){const e=this.measurement.getOwner();e.removeChild(e.getChildIndex(this.measurement)),this.measurement=null,this.highlightedItemB&&(this.highlightedItemB.removeHighlight("measure",!0),this.highlightedItemB=null),this.highlightedItemA&&(this.highlightedItemA.removeHighlight("measure",!0),this.highlightedItemA=null),this.stage=0}}snapToParametricEdge(e,t){const a=e.getParameter("GlobalXfo").getValue();if(e.hasParameter("CurveType")){const s=e.getParameter("CurveType").getValue();switch(s){case"Line":{const e=t.subtract(a.tr),s=a.ori.getXaxis();return a.tr.add(s.scale(e.dot(s)))}case"Circle":{const s=t.subtract(a.tr),i=e.getParameter("Radius").getValue()*a.sc.x,r=a.ori.getZaxis();s.subtractInPlace(r.scale(s.dot(r)));const n=s.length();return a.tr.add(s.scale(i/n))}default:console.log("Unhandled Edge Type: ",s)}}else if(e.hasParameter("SurfaceType")){const s=e.getParameter("SurfaceType").getValue();switch(s){case"Plane":{const e=t.subtract(a.tr),s=a.ori.getZaxis();return t.subtract(s.scale(e.dot(s)))}case"Cylinder":{const s=t.subtract(a.tr),i=a.ori.getZaxis(),r=a.tr.add(i.scale(s.dot(i))),n=e.getParameter("Radius").getValue()*a.sc.x,o=t.subtract(r),h=o.length();return r.add(o.scale(n/h))}default:console.log("Unhandled Surface Type: ",s)}}}onPointerDown(e){if(!(e.altKey||"mouse"===e.pointerType&&0!==e.button)&&e.intersectionData)if(0==this.stage){if(this.highlightedItemA){const a=e.pointerRay;let s;if(e.intersectionData)s=a.start.add(a.dir.scale(e.intersectionData.dist));else{const e=new t.Ray(new t.Vec3,new t.Vec3(0,0,1)),i=a.intersectRayPlane(e);s=a.start.add(a.dir.scale(i))}const r=this.snapToParametricEdge(this.highlightedItemA,s),n=this.colorParam.getValue();this.measurement=new oe("Measure Distance",n),this.measurement.setStartMarkerPos(r),this.measurement.setEndMarkerPos(r),this.appData.scene.getRoot().addChild(this.measurement),this.measurementChange=new ge(this.measurement),i.getInstance().addChange(this.measurementChange),this.stage++,e.stopPropagation()}}else if(1==this.stage&&this.highlightedItemB){const t=e.pointerRay,a=t.start.add(t.dir.scale(e.intersectionData.dist)),s=this.snapToParametricEdge(this.highlightedItemA,a),i=this.snapToParametricEdge(this.highlightedItemB,a);this.measurement.setStartMarkerPos(s),this.measurement.setEndMarkerPos(i),this.highlightedItemA&&(this.highlightedItemA.removeHighlight("measure",!0),this.highlightedItemA=null),this.highlightedItemB&&(this.highlightedItemB.removeHighlight("measure",!0),this.highlightedItemB=null),this.stage=0,this.measurement=null,e.stopPropagation()}}onPointerMove(e){if(!(e.altKey||"mouse"===e.pointerType&&0!==e.button))if(0==this.stage){if(e.intersectionData){const{geomItem:a}=e.intersectionData;(a.hasParameter("CurveType")||a.hasParameter("SurfaceType"))&&!a!=this.highlightedItemA&&(this.highlightedItemA&&this.highlightedItemA.removeHighlight("measure",!0),this.highlightedItemA=a,this.highlightedItemA.addHighlight("measure",new t.Color(1,1,1,.2),!0))}else this.highlightedItemA&&(this.highlightedItemA.removeHighlight("measure",!0),this.highlightedItemA=null);e.stopPropagation()}else if(1==this.stage){if(e.intersectionData){const{geomItem:a}=e.intersectionData;a!=this.highlightedItemA&&a!=this.highlightedItemB&&(a.hasParameter("CurveType")||a.hasParameter("SurfaceType"))&&(this.highlightedItemB&&(this.highlightedItemB.removeHighlight("measure",!0),this.highlightedItemB=null),this.highlightedItemB=a,this.highlightedItemB.addHighlight("measure",new t.Color(1,1,1,.2),!0))}else this.highlightedItemB&&(this.highlightedItemB.removeHighlight("measure",!0),this.highlightedItemB=null);e.stopPropagation()}}onPointerUp(e){}}class ue extends t.BaseTool{constructor(e){super(),this.colorParam=this.addParameter(new t.ColorParameter("Color",new t.Color("#F9CE03"))),e||console.error("App data not provided to tool"),this.appData=e,this.measurementChange=null,this.highlightedItemA=null,this.highlightedItemB=null,this.stage=0}activateTool(){super.activateTool(),this.appData&&this.appData.renderer&&(this.prevCursor=this.appData.renderer.getGLCanvas().style.cursor,this.appData.renderer.getGLCanvas().style.cursor="crosshair")}deactivateTool(){if(super.deactivateTool(),this.appData&&this.appData.renderer&&(this.appData.renderer.getGLCanvas().style.cursor=this.prevCursor),0!=this.stage){const e=this.measurement.getOwner();e.removeChild(e.getChildIndex(this.measurement)),this.measurement=null,this.highlightedItemB&&(this.highlightedItemB.removeHighlight("measure",!0),this.highlightedItemB=null),this.highlightedItemA&&(this.highlightedItemA.removeHighlight("measure",!0),this.highlightedItemA=null),this.stage=0}}highlightEdge(e,t){}snapToParametricCenter(e,t){const a=e.getParameter("GlobalXfo").getValue();if(e.hasParameter("CurveType")){const s=e.getParameter("CurveType").getValue();switch(s){case"Circle":{const e=t.subtract(a.tr),s=a.ori.getZaxis();return a.tr.add(s.scale(e.dot(s)))}default:console.log("Unhandled Edge Type: ",s)}}else if(e.hasParameter("SurfaceType")){const s=e.getParameter("SurfaceType").getValue();switch(s){case"Cylinder":case"Cone":{const e=t.subtract(a.tr),s=a.ori.getZaxis();return a.tr.add(s.scale(e.dot(s)))}default:console.log("Unhandled Surface Type: ",s)}}}onPointerDown(e){if(!(e.altKey||"mouse"===e.pointerType&&0!==e.button)&&e.intersectionData)if(0==this.stage){if(this.highlightedItemA){const a=e.pointerRay;let s;if(e.intersectionData)s=a.start.add(a.dir.scale(e.intersectionData.dist));else{const e=new t.Ray(new t.Vec3,new t.Vec3(0,0,1)),i=a.intersectRayPlane(e);s=a.start.add(a.dir.scale(i))}const r=this.snapToParametricCenter(this.highlightedItemA,s),n=this.colorParam.getValue();this.measurement=new oe("Measure Distance",n),this.measurement.setStartMarkerPos(r),this.measurement.setEndMarkerPos(r),this.appData.scene.getRoot().addChild(this.measurement),this.measurementChange=new ge(this.measurement),i.getInstance().addChange(this.measurementChange),this.stage++,e.stopPropagation()}}else if(1==this.stage&&this.highlightedItemB){const t=e.pointerRay,a=t.start.add(t.dir.scale(e.intersectionData.dist));let s=this.snapToParametricCenter(this.highlightedItemB,a);const i=this.snapToParametricCenter(this.highlightedItemA,s);s=this.snapToParametricCenter(this.highlightedItemB,i),this.measurement.setStartMarkerPos(i),this.measurement.setEndMarkerPos(s),this.highlightedItemA&&(this.highlightedItemA.removeHighlight("measure",!0),this.highlightedItemA=null),this.highlightedItemB&&(this.highlightedItemB.removeHighlight("measure",!0),this.highlightedItemB=null),this.stage=0,this.measurement=null,e.stopPropagation()}}checkGeom(e){if(e.hasParameter("CurveType")){return"Circle"==e.getParameter("CurveType").getValue()}if(e.hasParameter("SurfaceType")){const t=e.getParameter("SurfaceType");return"Cone"==t.getValue()||"Cylinder"==t.getValue()}}onPointerMove(e){if(!(e.altKey||"mouse"===e.pointerType&&0!==e.button))if(0==this.stage){if(e.intersectionData){const{geomItem:t}=e.intersectionData;if(t!=this.highlightedItemA&&this.checkGeom(t)){this.highlightedItemA&&this.highlightedItemA.removeHighlight("measure",!0),this.highlightedItemA=t;const e=this.colorParam.getValue().clone();e.a=.2,this.highlightedItemA.addHighlight("measure",e,!0)}}else this.highlightedItemA&&(this.highlightedItemA.removeHighlight("measure",!0),this.highlightedItemA=null);e.stopPropagation()}else if(1==this.stage){if(e.intersectionData){const{geomItem:t}=e.intersectionData;if(t!=this.highlightedItemA&&t!=this.highlightedItemB&&this.checkGeom(t)){this.highlightedItemB&&(this.highlightedItemB.removeHighlight("measure",!0),this.highlightedItemB=null),this.highlightedItemB=t;const e=this.colorParam.getValue().clone();e.a=.2,this.highlightedItemB.addHighlight("measure",e,!0)}}else this.highlightedItemB&&(this.highlightedItemB.removeHighlight("measure",!0),this.highlightedItemB=null);e.stopPropagation()}}onPointerUp(e){}}class me extends t.BaseTool{constructor(e){super(),this.colorParam=this.addParameter(new t.ColorParameter("Color",new t.Color("#F9CE03"))),e||console.error("App data not provided to tool"),this.appData=e,this.highlightedItemA=null}activateTool(){super.activateTool(),this.appData&&this.appData.renderer&&(this.prevCursor=this.appData.renderer.getGLCanvas().style.cursor,this.appData.renderer.getGLCanvas().style.cursor="crosshair")}deactivateTool(){super.deactivateTool(),this.appData&&this.appData.renderer&&(this.appData.renderer.getGLCanvas().style.cursor=this.prevCursor)}onPointerDown(e){if(!(e.altKey||"mouse"===e.pointerType&&0!==e.button)&&e.intersectionData&&this.highlightedItemA){const a=e.pointerRay;let s;if(e.intersectionData)s=a.start.add(a.dir.scale(e.intersectionData.dist));else{const e=new t.Ray(new t.Vec3,new t.Vec3(0,0,1)),i=a.intersectRayPlane(e);s=a.start.add(a.dir.scale(i))}const r=this.highlightedItemA,n=r.getParameter("GlobalXfo").getValue();let o,h;if(r.hasParameter("CurveType")){const e=r.getParameter("CurveType").getValue();switch(e){case"Circle":{const e=s.subtract(n.tr),t=r.getParameter("Radius").getValue()*n.sc.x,a=n.ori.getZaxis();e.subtractInPlace(a.scale(e.dot(a)));const i=e.length();o=n.tr,h=o.add(e.scale(t/i))}default:console.log("Unhandled Edge Type: ",e)}}else if(r.hasParameter("SurfaceType")){const e=r.getParameter("SurfaceType").getValue();switch(e){case"Cylinder":{const e=s.subtract(n.tr),t=n.ori.getZaxis();o=n.tr.add(t.scale(e.dot(t)));const a=r.getParameter("Radius").getValue()*n.sc.x,i=s.subtract(o),l=i.length();h=o.add(i.scale(a/l))}default:console.log("Unhandled Surface Type: ",e)}}const l=this.colorParam.getValue(),c=new oe("MeasureRadius",l);c.setStartMarkerPos(o),c.setEndMarkerPos(h),c.setGeomBuffersVisibility(!1),this.appData.scene.getRoot().addChild(c);const g=new ge(c);i.getInstance().addChange(g),this.highlightedItemA&&this.highlightedItemA.removeHighlight("measure",!0),e.stopPropagation()}}onPointerMove(e){if(!(e.altKey||"mouse"===e.pointerType&&0!==e.button||this.dragging))if(e.intersectionData){const{geomItem:t}=e.intersectionData;if((t.hasParameter("CurveType")&&"Circle"==t.getParameter("CurveType").getValue()||t.hasParameter("SurfaceType")&&"Cylinder"==t.getParameter("SurfaceType").getValue())&&t!=this.highlightedItemA){this.highlightedItemA&&this.highlightedItemA.removeHighlight("measure",!0),this.highlightedItemA=t;const e=this.colorParam.getValue().clone();e.a=.2,this.highlightedItemA.addHighlight("measure",e,!0)}}else this.highlightedItemA&&(this.highlightedItemA.removeHighlight("measure",!0),this.highlightedItemA=null)}onPointerUp(e){}}class pe extends t.BaseTool{constructor(e){super(),this.colorParam=this.addParameter(new t.ColorParameter("Color",new t.Color("#F9CE03"))),e||console.error("App data not provided to tool"),this.appData=e,this.measurementChange=null,this.highlightedItemA=null,this.highlightedItemAHitPos=null,this.highlightedItemB=null,this.stage=0}activateTool(){super.activateTool(),this.appData&&this.appData.renderer&&(this.prevCursor=this.appData.renderer.getGLCanvas().style.cursor,this.appData.renderer.getGLCanvas().style.cursor="crosshair")}deactivateTool(){if(super.deactivateTool(),this.appData&&this.appData.renderer&&(this.appData.renderer.getGLCanvas().style.cursor=this.prevCursor),0!=this.stage){const e=this.measurement.getOwner();e.removeChild(e.getChildIndex(this.measurement)),this.measurement=null,this.highlightedItemB&&(this.highlightedItemB.removeHighlight("measure",!0),this.highlightedItemB=null),this.highlightedItemA&&(this.highlightedItemA.removeHighlight("measure",!0),this.highlightedItemA=null),this.stage=0}}checkSurface(e){const t=e.getParameter("SurfaceType");return t&&("Plane"==t.getValue()||"Cone"==t.getValue()||"Cylinder"==t.getValue())}onPointerDown(e){if(e.altKey||"mouse"===e.pointerType&&0!==e.button||!e.intersectionData)return;const a=(a,s,i)=>{const r=new t.Xfo,n=a.getParameter("SurfaceType");if(n){const o=n.getValue();switch(o){case"Plane":{const n=a.getParameter("GeomMat").getValue(),o=s.subtract(n.translation);let h=n.zAxis.clone();h.dot(e.pointerRay.dir)>0&&(h=h.negate());const l=s;if(i){const e=h,t=i.ori.getZaxis(),a=i.tr.subtract(s),r=e.cross(t).normalize();l.addInPlace(r.scale(a.dot(r)))}r.ori.setFromDirectionAndUpvector(h,new t.Vec3(h.z,h.x,h.y)),r.tr=l.subtract(h.scale(o.dot(h)));break}case"Cone":{const e=a.getParameter("GlobalXfo").getValue(),n=a.getParameter("SemiAngle").getValue(),o=a.getParameter("StartRadius").getValue(),h=e.ori.getZaxis(),l=s.subtract(e.tr).dot(h),c=o+Math.tan(n)*l;let g=s;if(i){const t=i.tr.subtract(e.tr);t.subtractInPlace(h.scale(t.dot(h))),g=e.tr.add(t.normalize().scale(c)),g.addInPlace(h.scale(l))}const d=g.subtract(e.tr);r.ori.setFromDirectionAndUpvector(h,d);const u=new t.Quat;u.setFromAxisAndAngle(new t.Vec3(1,0,0),n),r.ori.multiplyInPlace(u),r.tr=g;const m=e.ori.getZaxis().angleTo(r.ori.getZaxis());console.log(m,n);break}case"Cylinder":{const e=a.getParameter("GlobalXfo").getValue(),n=a.getParameter("Radius").getValue()*e.sc.x,o=e.ori.getZaxis(),h=s.subtract(e.tr).dot(o),l=e.tr.add(o.scale(h)),c=s.subtract(l),g=c.length();let d=l.add(c.scale(n/g));if(i){const t=i.tr.subtract(e.tr);t.subtractInPlace(o.scale(t.dot(o))),d=e.tr.add(t.normalize().scale(n)),d.addInPlace(o.scale(h))}const u=d.subtract(e.tr);r.ori.setFromDirectionAndUpvector(o,u);const m=new t.Quat;m.setFromAxisAndAngle(new t.Vec3(1,0,0),.5*Math.PI),r.ori.multiplyInPlace(m),r.tr=d;break}default:console.log("Unhandled Surface Type: ",o)}}return r};if(0==this.stage){const{geomItem:t}=e.intersectionData;if(this.checkSurface(t)){const s=this.colorParam.getValue();this.measurement=new ce("MeasureAngle",s),this.appData.scene.getRoot().addChild(this.measurement);const i=e.pointerRay,r=i.start.add(i.dir.scale(e.intersectionData.dist)),n=a(t,r);this.measurement.setXfoA(n),this.geomItemA=t,this.hitPosA=r,this.stage++,e.stopPropagation()}}else if(1==this.stage){const{geomItem:t}=e.intersectionData;if(this.checkSurface(t)){const s=e.pointerRay,r=a(t,s.start.add(s.dir.scale(e.intersectionData.dist))),n=a(this.geomItemA,this.hitPosA,r);this.measurement.setXfoA(n),this.measurement.setXfoB(r);const o=new ge(this.measurement);i.getInstance().addChange(o),this.highlightedItemA&&this.highlightedItemA.removeHighlight("measure",!0),this.highlightedItemB&&this.highlightedItemB.removeHighlight("measure",!0),this.stage=0,e.stopPropagation()}}}onPointerMove(e){if(!(e.altKey||"mouse"===e.pointerType&&0!==e.button))if(0==this.stage)if(e.intersectionData){const{geomItem:t}=e.intersectionData;if(this.checkSurface(t)&&t!=this.highlightedItemA){this.highlightedItemA&&this.highlightedItemA.removeHighlight("measure",!0),this.highlightedItemA=t;const e=this.colorParam.getValue().clone();e.a=.2,this.highlightedItemA.addHighlight("measure",e,!0)}}else this.highlightedItemA&&(this.highlightedItemA.removeHighlight("measure",!0),this.highlightedItemA=null);else if(1==this.stage)if(e.intersectionData){const{geomItem:t}=e.intersectionData;if(t!=this.highlightedItemA&&t!=this.highlightedItemB&&this.checkSurface(t)){this.highlightedItemB&&this.highlightedItemB.removeHighlight("measure",!0),this.highlightedItemB=t;const e=this.colorParam.getValue().clone();e.a=.2,this.highlightedItemB.addHighlight("measure",e,!0)}}else this.highlightedItemB&&(this.highlightedItemB.removeHighlight("measure",!0),this.highlightedItemB=null)}onPointerUp(e){this.dragging&&(this.dragging=!1,this.measurementChange=null,this.highlightedItemA&&this.highlightedItemA.removeHighlight("measure",!0),e.stopPropagation())}}e.ArcSlider=ie,e.AxialRotationHandle=d,e.Change=n,e.CreateCircleChange=$,e.CreateCircleTool=class extends j{constructor(e){super(e)}createStart(e){this.change=new $(this.parentItem,e),i.getInstance().addChange(this.change),this.xfo=e,this.stage=1,this.radius=0}createMove(e){this.radius=e.distanceTo(this.xfo.tr),this.change.update({radius:this.radius}),this.appData.renderer.forceRender()}createRelease(e){0==this.radius&&i.getInstance().cancel(),this.change=null,this.stage=0,this.emit("actionFinished")}},e.CreateConeChange=W,e.CreateConeTool=class extends j{constructor(e){super(e)}createStart(e){this.xfo=e,this.invXfo=e.inverse(),this.change=new W(this.parentItem,e,this.colorParam.getValue()),i.getInstance().addChange(this.change),this.stage=1,this._radius=0,this._height=0}createMove(e){if(1==this.stage){const t=e.subtract(this.xfo.tr);this._radius=t.length(),this.change.update({radius:this._radius})}else this._height=this.invXfo.transformVec3(e).y,this.change.update({height:this._height})}createRelease(e){if(0==this._radius&&(i.getInstance().cancel(),this.stage=0,this.emit("actionFinished")),1==this.stage){this.stage=2;const a=new t.Quat;a.setFromAxisAndAngle(new t.Vec3(1,0,0),.5*Math.PI),this.constructionPlane.ori=this.constructionPlane.ori.multiply(a),this.constructionPlane.tr=e,this.invXfo=this.constructionPlane.inverse()}else 2==this.stage&&(this.stage=0,this.emit("actionFinished"))}},e.CreateCuboidChange=te,e.CreateCuboidTool=class extends j{constructor(e){super(e)}createStart(e){this.change=new te(this.parentItem,e,this.colorParam.getValue()),i.getInstance().addChange(this.change),this.xfo=e,this.invXfo=e.inverse(),this.stage=1,this._height=0}createMove(e){if(1==this.stage){const t=this.invXfo.transformVec3(e);this.change.update({baseSize:[Math.abs(t.x),Math.abs(t.y)],tr:this.xfo.tr.add(t.scale(.5))})}else{const t=this.invXfo.transformVec3(e);this.change.update({height:t.y})}}createRelease(e){if(1==this.stage){this.stage=2,this.pt1=e;const a=new t.Quat;a.setFromAxisAndAngle(new t.Vec3(1,0,0),.5*Math.PI),this.constructionPlane.ori=this.constructionPlane.ori.multiply(a),this.constructionPlane.tr=e,this.invXfo=this.constructionPlane.inverse()}else 2==this.stage&&(this.stage=0,this.emit("actionFinished"))}},e.CreateFreehandLineChange=Q,e.CreateFreehandLineTool=class extends Y{constructor(e){super(e),this.mp=this.addParameter(new t.BooleanParameter("Modulate Thickness By Stroke Speed",!1))}createStart(e){const t=this.colorParam.getValue(),a=this.lineThickness.getValue();this.change=new Q(this.parentItem,e,t,a),i.getInstance().addChange(this.change),this.xfo=e,this.invXfo=e.inverse(),this.stage=1,this.prevP=e.tr,this.length=0}createMove(e){const t=this.invXfo.transformVec3(e),a=t.subtract(this.prevP).length();this.change.update({point:t}),this.length+=a,this.prevP=t}createRelease(e){0==this.length&&i.getInstance().cancel(),this.stage=0,this.emit("actionFinished")}},e.CreateLineChange=K,e.CreateLineTool=Y,e.CreateRectChange=q,e.CreateRectTool=class extends j{constructor(e){super(e)}createStart(e){this.change=new q(this.parentItem,e),i.getInstance().addChange(this.change),this.xfo=e,this.invXfo=e.inverse(),this.stage=1,this._size=0}createMove(e){if(1==this.stage){const t=this.invXfo.transformVec3(e);this._size=Math.abs(t.x),Math.abs(t.y),this.change.update({baseSize:[Math.abs(t.x),Math.abs(t.y)],tr:this.xfo.tr.add(t.scale(.5))})}else{const t=this.invXfo.transformVec3(e);this.change.update({height:t.y})}}createRelease(e){0==this._size&&i.getInstance().cancel(),this.stage=0,this.emit("actionFinished")}},e.CreateSphereChange=ee,e.CreateSphereTool=class extends j{constructor(e){super(e)}createStart(e){this.change=new ee(this.parentItem,e,this.colorParam.getValue()),i.getInstance().addChange(this.change),this.xfo=e,this.stage=1,this.radius=0}createMove(e){this.radius=e.distanceTo(this.xfo.tr),this.change.update({radius:this.radius})}createRelease(e){0==this.radius&&i.getInstance().cancel(),this.stage=0,this.emit("actionFinished")}},e.LinearMovementHandle=c,e.MeasureAngle=ce,e.MeasureAngleTool=pe,e.MeasureCenterDistancesTool=ue,e.MeasureDistance=oe,e.MeasureDistanceTool=de,e.MeasureRadiusTool=me,e.MeasurementChange=ge,e.ParameterValueChange=o,e.PlanarMovementHandle=u,e.ScreenSpaceMovementHandle=class extends a{constructor(e){super(e)}setTargetParam(e,t=!0){if(this.param=e,t){const t=()=>{this.getParameter("GlobalXfo").setValue(e.getValue())};t(),e.on("valueChanged",t)}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}handlePointerDown(e){this.gizmoRay=new t.Ray;const a=e.pointerRay,s=e.viewport.getCamera().getParameter("GlobalXfo").getValue();this.gizmoRay.dir=s.ori.getZaxis();const i=this.getTargetParam().getValue();this.gizmoRay.start=i.tr;const r=a.intersectRayPlane(this.gizmoRay);return e.grabPos=a.pointAtDist(r),this.onDragStart(e),!0}handlePointerMove(e){const t=e.pointerRay,a=t.intersectRayPlane(this.gizmoRay);return e.holdPos=t.pointAtDist(a),this.onDrag(e),!0}handlePointerUp(e){const t=e.pointerRay;if(t){const a=t.intersectRayPlane(this.gizmoRay);e.releasePos=t.pointAtDist(a)}return this.onDragEnd(e),!0}onDragStart(e){this.grabPos=e.grabPos;const t=this.getTargetParam();this.baseXfo=t.getValue(),this.change=new o(t),i.getInstance().addChange(this.change)}onDrag(e){const t=e.holdPos.subtract(this.grabPos),a=this.baseXfo.clone();a.tr.addInPlace(t),this.change.update({value:a})}onDragEnd(e){this.change=null}},e.SelectionChange=C,e.SelectionManager=v,e.SelectionTool=b,e.SelectionVisibilityChange=_,e.SliderHandle=se,e.ToolManager=ae,e.TreeItemAddChange=w,e.TreeItemMoveChange=V,e.TreeItemsRemoveChange=S,e.UndoRedoManager=i,e.VRHoldObjectsTool=F,e.VRUITool=U,e.XfoHandle=p,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=index.umd.js.map
